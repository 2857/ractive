<!DOCTYPE html>  <html> <head>   <title>TextViews.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="Anglebars.html">                 Anglebars.js               </a>                                           <a class="source" href="DomViews.html">                 DomViews.js               </a>                                           <a class="source" href="TextViews.html">                 TextViews.js               </a>                                           <a class="source" href="ViewModel.html">                 ViewModel.js               </a>                                           <a class="source" href="utils.html">                 utils.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               TextViews.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span> <span class="p">(</span> <span class="nx">A</span> <span class="p">)</span> <span class="p">{</span>

  <span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">textViewMustache</span><span class="p">,</span> <span class="nx">TextViews</span><span class="p">,</span> <span class="nx">types</span><span class="p">,</span> <span class="nx">ctors</span><span class="p">;</span>

  <span class="nx">types</span> <span class="o">=</span> <span class="nx">A</span><span class="p">.</span><span class="nx">types</span><span class="p">;</span>

  <span class="nx">ctors</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nx">ctors</span><span class="p">[</span> <span class="nx">types</span><span class="p">.</span><span class="nx">TEXT</span> <span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Text&#39;</span><span class="p">;</span>
  <span class="nx">ctors</span><span class="p">[</span> <span class="nx">types</span><span class="p">.</span><span class="nx">INTERPOLATOR</span> <span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Interpolator&#39;</span><span class="p">;</span>
  <span class="nx">ctors</span><span class="p">[</span> <span class="nx">types</span><span class="p">.</span><span class="nx">TRIPLE</span> <span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Triple&#39;</span><span class="p">;</span>
  <span class="nx">ctors</span><span class="p">[</span> <span class="nx">types</span><span class="p">.</span><span class="nx">SECTION</span> <span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Section&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Substring constructor factory</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">textViewMustache</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">proto</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Mustache</span><span class="p">;</span>

    <span class="nx">Mustache</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">model</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">anglebars</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">anglebars</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">viewmodel</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">anglebars</span><span class="p">.</span><span class="nx">viewmodel</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">contextStack</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">contextStack</span> <span class="o">||</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>if there is an init method, call it</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">initialize</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">viewmodel</span><span class="p">.</span><span class="nx">registerView</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>if we have a failed keypath lookup, and this is an inverted section,
we need to trigger this.update() so the contents are rendered</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">keypath</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">inverted</span> <span class="p">)</span> <span class="p">{</span> <span class="c1">// test both section-hood and inverticity in one go</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span> <span class="kc">false</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">Mustache</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">proto</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">Mustache</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Substring types</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">TextViews</span> <span class="o">=</span> <span class="nx">A</span><span class="p">.</span><span class="nx">TextViews</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">create</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">TextViews</span><span class="p">[</span> <span class="nx">ctors</span><span class="p">[</span> <span class="nx">options</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">type</span> <span class="p">]</span> <span class="p">](</span> <span class="nx">options</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Fragment</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">TextViews</span><span class="p">.</span><span class="nx">Fragment</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">numItems</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">itemOptions</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="nx">itemOptions</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">anglebars</span><span class="o">:</span>    <span class="nx">options</span><span class="p">.</span><span class="nx">anglebars</span><span class="p">,</span>
      <span class="nx">parent</span><span class="o">:</span>       <span class="k">this</span><span class="p">,</span>
      <span class="nx">contextStack</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">contextStack</span>
    <span class="p">};</span>

    <span class="nx">numItems</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">numItems</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">itemOptions</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">TextViews</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">itemOptions</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">TextViews</span><span class="p">.</span><span class="nx">Fragment</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">bubble</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span> <span class="s1">&#39;&#39;</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">bubble</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">numItems</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span>

      <span class="nx">numItems</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">numItems</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">teardown</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Plain text</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">TextViews</span><span class="p">.</span><span class="nx">Text</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">TextViews</span><span class="p">.</span><span class="nx">Text</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span> <span class="c1">// no-op</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Mustaches</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Interpolator or Triple</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">TextViews</span><span class="p">.</span><span class="nx">Interpolator</span> <span class="o">=</span> <span class="nx">textViewMustache</span><span class="p">({</span>
    <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">bubble</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">bubble</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">bubble</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">observerRefs</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">viewmodel</span><span class="p">.</span><span class="nx">cancelAddressResolution</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">viewmodel</span><span class="p">.</span><span class="nx">unobserveAll</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">observerRefs</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Triples are the same as Interpolators in this context</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">TextViews</span><span class="p">.</span><span class="nx">Triple</span> <span class="o">=</span> <span class="nx">TextViews</span><span class="p">.</span><span class="nx">Interpolator</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Section</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">TextViews</span><span class="p">.</span><span class="nx">Section</span> <span class="o">=</span> <span class="nx">textViewMustache</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">unrender</span><span class="p">();</span>

      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">observerRefs</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">viewmodel</span><span class="p">.</span><span class="nx">cancelAddressResolution</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">viewmodel</span><span class="p">.</span><span class="nx">unobserveAll</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">observerRefs</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">unrender</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">shift</span><span class="p">().</span><span class="nx">teardown</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">bubble</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span> <span class="s1">&#39;&#39;</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">bubble</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">emptyArray</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">childrenToRemove</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>treat empty arrays as false values</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="nx">A</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">emptyArray</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>if section is inverted, only check for truthiness/falsiness</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">inverted</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">emptyArray</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">unrender</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TextViews</span><span class="p">.</span><span class="nx">Fragment</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">anglebars</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">contextStack</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span> <span class="s1">&#39;&#39;</span> <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">bubble</span><span class="p">();</span>

        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Otherwise we need to work out what sort of section we're dealing with.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>if value is an array, iterate through</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">A</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>if the array is shorter than it was previously, remove items</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">childrenToRemove</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="p">);</span>

            <span class="k">while</span> <span class="p">(</span> <span class="nx">childrenToRemove</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">childrenToRemove</span><span class="p">.</span><span class="nx">shift</span><span class="p">().</span><span class="nx">teardown</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>otherwise...</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>first, update existing views</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">viewmodel</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">keypath</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">i</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>then add any new ones</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TextViews</span><span class="p">.</span><span class="nx">Fragment</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">anglebars</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">contextStack</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">keypath</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">);</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>if value is a hash...</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>...then if it isn't rendered, render it, adding this.keypath to the context stack
(if it is already rendered, then any children dependent on the context stack
will update themselves without any prompting)</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TextViews</span><span class="p">.</span><span class="nx">Fragment</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">anglebars</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">contextStack</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">keypath</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>otherwise render if value is truthy, unrender if falsy</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">emptyArray</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TextViews</span><span class="p">.</span><span class="nx">Fragment</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">anglebars</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">contextStack</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">unrender</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span> <span class="s1">&#39;&#39;</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">bubble</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>

<span class="p">}(</span> <span class="nx">Anglebars</span> <span class="p">));</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 