/*! Anglebars - v0.1.2 - 2013-01-27
* http://rich-harris.github.com/Anglebars/
* Copyright (c) 2013 Rich Harris; Licensed WTFPL */

/*jslint eqeq: true, plusplus: true */
/*global document, HTMLElement */

'use strict';


"use strict";(function(e){var t,n,r,i;t=function(e){var i;e=e||{},i={preserveWhitespace:!1,async:!1,maxBatch:50,append:!1,twoway:!0,compiledPartials:{},formatters:{}},n(this,i),n(this,e),this.el=r(this.el),this.viewmodel=this.data instanceof t.ViewModel?this.data:new t.ViewModel(this.data);if(this.partials)for(var s in this.partials)this.partials.hasOwnProperty(s)&&(this.compiledPartials[s]=t.compile(this.partials[s],{preserveWhitespace:this.preserveWhitespace,replaceSrcAttributes:this.replaceSrcAttributes}));!this.compiled&&this.template&&(this.compiled=t.compile(this.template,{preserveWhitespace:this.preserveWhitespace,replaceSrcAttributes:this.replaceSrcAttributes,namespace:this.namespace,partials:this.compiledPartials})),this.compiled&&this.el&&this.render({el:this.el,callback:this.callback,append:this.append})},t.prototype={queue:function(e){this._queue=e.concat(this._queue||[]),this._dispatchingQueue||this.dispatchQueue()},dispatchQueue:function(){var e=this,n,r;r=this.maxBatch,n=function(){var s=+(new Date),o;while(e._queue.length&&new Date-s<r)o=e._queue.shift(),o.parentFragment.items[o.index]=t.DomViews.create(o);e._queue.length?i(n):(e._dispatchingQueue=!1,e.callback&&(e.callback(),delete e.callback),e.async=!1)},this._dispatchingQueue=!0,i(n)},render:function(e){var n=e.el?r(e.el):this.el;if(!n)throw new Error("You must specify a DOM element to render to");e.append||(n.innerHTML=""),e.callback&&(this.callback=e.callback),this.rendered=new t.DomViews.Fragment({model:this.compiled,anglebars:this,parentNode:n}),!this.async&&e.callback&&e.callback()},teardown:function(){this.rendered.teardown()},set:function(){var e=this.el.style.display;return this.viewmodel.set.apply(this.viewmodel,arguments),this},get:function(){return this.viewmodel.get.apply(this.viewmodel,arguments)},update:function(){return this.viewmodel.update.apply(this.viewmodel,arguments),this},observe:function(){return this.viewmodel.observe.apply(this.viewmodel,arguments)},unobserve:function(){return this.viewmodel.unobserve.apply(this.viewmodel,arguments),this},_format:function(e,n){var r,i,s,o,u,a;console.group("Formatting",e);if(!n)return console.log("no formatters"),console.groupEnd(),e;i=n.length;for(r=0;r<i;r+=1)s=n[r],o=s.name,u=s.args||[],a=this.formatters[o]||t.formatters[o],a&&(e=a.apply(this,[e].concat(u)));return console.groupEnd(),e}},t.compile=function(e,t){},t.patterns={arrayPointer:/\[([0-9]+)\]/},t.types={TEXT:1,INTERPOLATOR:2,TRIPLE:3,SECTION:4,INVERTED:5,CLOSING:6,ELEMENT:7,PARTIAL:8,COMMENT:9,DELIMCHANGE:10,MUSTACHE:11,TAG:12,ATTR_VALUE_TOKEN:13},t.formatters={equals:function(e,t){return e===t},greaterThan:function(e,t){return e>t},greaterThanEquals:function(e,t){return e>=t},lessThan:function(e,t){return e<t},lessThanEquals:function(e,t){return e<=t}},n=function(e,t){var n;for(n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},r=function(e){var t;if(!e)throw new Error("No container element specified");if(e.tagName)return e;if(typeof e=="string"){t=document.getElementById(e);if(t.tagName)return t}throw new Error("Could not find container element")},i=function(){var e=["ms","moz","webkit","o"],t,n,r;if(typeof window=="undefined")return;if(window.requestAnimationFrame)return function(e){window.requestAnimationFrame(e)};n=function(t){if(window[e[t]+"RequestAnimationFrame"])return function(n){window[e[t]+"RequestAnimationFrame"](n)}};for(t=0;t<e.length;t+=1)n(t);return function(e){setTimeout(e,16)}}(),t.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"},t.isObject=function(e){return Object.prototype.toString.call(e)==="[object Object]"&&typeof e!="function"},function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b;e.tokenize=function(e){var t=i.fromString(r(e));return t.tokens},i=function(){this.tokens=[],this.buffer=new s},i.prototype={read:function(e){var n,r;if(this.currentToken&&this.currentToken.type===t.TAG&&this.currentToken.read(e))return!0;if(this.buffer.read(e))return!0;n=this.buffer.convert();if(n)return this.currentToken&&this.currentToken.seal(),this.currentToken=this.tokens[this.tokens.length]=n,!0;r=this.buffer.release();if(this.currentToken){while(r.length){while(r.length&&this.currentToken.read(r.charAt(0)))r=r.substring(1);r.length&&(r.charAt(0)==="<"?(this.currentToken=new f,this.currentToken.read("<")):(this.currentToken=new o,this.currentToken.read(r.charAt(0))),this.tokens[this.tokens.length]=this.currentToken,r=r.substring(1))}return!0}return e==="<"?this.currentToken=new f:this.currentToken=new o,this.currentToken.read(e),this.tokens[this.tokens.length]=this.currentToken,!0},end:function(){this.buffer.isEmpty()||(this.tokens[this.tokens.length]=this.buffer.convert())}},i.fromString=function(e){var t,n,r;t=new i,n=0,r=e.length;while(n<r)t.read(e.charAt(n)),n+=1;return t.end(),t},s=function(){this.value=""},s.prototype={read:function(t){var n;return this.value+=t,n=this.isPartialMatchOf(e.delimiters[0])||this.isPartialMatchOf(e.tripleDelimiters[0]),n},convert:function(){var t,n,r,i,s,o;n=e.delimiters[0],r=e.tripleDelimiters[0],t=this.value,s=function(){if(t.indexOf(r)===0)return new a},o=function(){if(t.indexOf(n)===0)return new u},r.length>n.length?i=s()||o():i=o()||s();if(i){while(this.value.length)i.read(this.value.charAt(0)),this.value=this.value.substring(1);return i}return!1},release:function(){var e=this.value;return this.value="",e},isEmpty:function(){return!this.value.length},isPartialMatchOf:function(e){return e.indexOf(this.value)===0}},o=function(){this.type=t.TEXT,this.value=""},o.prototype={read:function(e){return this.sealed?!1:e==="<"?!1:(this.value+=e,!0)},seal:function(){this.sealed=!0}},u=function(){this.value="",this.openingDelimiter=e.delimiters[0],this.closingDelimiter=e.delimiters[1]},a=function(){this.value="",this.openingDelimiter=e.tripleDelimiters[0],this.closingDelimiter=e.tripleDelimiters[1],this.type=t.TRIPLE},u.prototype=a.prototype={read:function(e){return this.sealed?!1:(this.value+=e,this.value.substr(-this.closingDelimiter.length)===this.closingDelimiter&&this.seal(),!0)},seal:function(){var e,n,r;if(this.sealed)return;e=this.value.replace(this.openingDelimiter,"").replace(this.closingDelimiter,"").trim(),e.charAt(0)==="="&&(this.changeDelimiters(e),this.type=t.DELIMCHANGE),this.type||(n=e.charAt(0),c[n]?(this.type=c[n],e=e.substring(1).trim()):this.type=t.INTERPOLATOR),r=e.split("|"),this.ref=r.shift().trim(),r.length&&(this.formatters=r.map(function(e){return e.trim()})),this.sealed=!0},changeDelimiters:function(n){var r,i;i=/\=([^\s=]+)\s+([^\s=]+)=/.exec(n),r=this.type===t.TRIPLE?e.tripleDelimiters:e.delimiters,r[0]=i[1],r[1]=i[2]}},f=function(){this.type=t.TAG,this.openingBracket=new h,this.closingTagSolidus=new v,this.tagName=new p,this.attributes=new d,this.selfClosingSolidus=new v,this.closingBracket=new m},f.prototype={read:function(e){var t;return this.sealed?!1:(t=this.openingBracket.read(e)||this.closingTagSolidus.read(e)||this.tagName.read(e)||this.attributes.read(e)||this.selfClosingSolidus.read(e)||this.closingBracket.read(e),t?(this.closingBracket.sealed&&this.seal(),!0):(this.seal(),!1))},seal:function(){this.tag=this.tagName.value,this.closingTagSolidus.value&&(this.isClosingTag=!0),this.selfClosingSolidus.value&&(this.isSelfClosingTag=!0),this.sealed=!0}},h=function(){},h.prototype={read:function(e){if(this.sealed)return!1;if(e==="<")return this.value="<",this.seal(),!0;throw'Expected "<", saw "'+e+'"'},seal:function(){this.sealed=!0}},p=function(){},p.prototype={read:function(e){return this.sealed?!1:!this.value&&/[a-zA-Z]/.test(e)?(this.value=e,!0):/[a-zA-Z0-9\-]/.test(e)?(this.value+=e,!0):(this.seal(),!1)},seal:function(){this.sealed=!0}},d=function(){this.items=[]},d.prototype={read:function(e){return this.sealed?!1:this.nextItem&&this.nextItem.read(e)?!0:n.test(e)?!0:(this.nextItem=new g,this.nextItem.read(e)?(this.items[this.items.length]=this.nextItem,!0):(this.seal(),!1))},seal:function(){this.sealed=!0}},g=function(){this.name=new y,this.value=new b},g.prototype={read:function(e){return this.sealed?!1:this.name.read(e)?!0:this.name.value?this.value.read(e)?!0:(this.seal(),!1):(this.seal(),!1)},seal:function(){this.sealed=!0}},y=function(){},y.prototype={read:function(e){return this.sealed?!1:this.value?/[_:a-zA-Z0-9\.\-]/.test(e)?(this.value+=e,!0):(this.seal(),!1):/[a-zA-Z_:]/.test(e)?(this.value=e,!0):(this.seal(),!1)},seal:function(){this.sealed=!0}},b=function(){this.tokens=[],this.buffer=new s,this.expected=!1},b.prototype={read:function(e){var t,r;if(this.sealed)return!1;if(!this.expected)return n.test(e)?!0:e==="="?(this.expected=!0,!0):!1;if(!this.tokens.length){if(n.test(e))return!0;if(e==='"'||e==="'")return this.quoteMark=e,!0}if(this.buffer.read(e))return!0;t=this.buffer.convert();if(t)return this.currentToken&&this.currentToken.seal(),this.currentToken=this.tokens[this.tokens.length]=t,!0;r=this.buffer.release();if(this.currentToken){while(r.length){while(r.length&&r.charAt(0)!==this.quoteMark&&this.currentToken.read(r.charAt(0)))r=r.substring(1);r.length&&r.charAt(0)!==this.quoteMark&&(this.currentToken=new l(this.quoteMark),this.currentToken.read(r.charAt(0)),this.tokens[this.tokens.length]=this.currentToken,r=r.substring(1));if(r.charAt(0)===this.quoteMark)return this.currentToken.seal(),this.seal(),!0}return!0}return this.currentToken=new l(this.quoteMark),this.currentToken.read(e),this.tokens[this.tokens.length]=this.currentToken,!0},seal:function(){this.sealed=!0}},l=function(e){this.type=t.ATTR_VALUE_TOKEN,this.quoteMark=e||"",this.value=""},l.prototype={read:function(e){return this.sealed?!1:e===this.quoteMark?(this.seal(),!0):this.quoteMark?(this.value+=e,!0):/[\s"'=<>`]/.test(e)?(this.seal(),!1):(this.value+=e,!0)},seal:function(){this.sealed=!0}},v=function(){},v.prototype={read:function(e){return this.sealed?!1:e==="/"?(this.value="/",this.seal(),!0):(this.seal(),!1)},seal:function(){this.sealed=!0}},m=function(){},m.prototype={read:function(e){if(this.sealed)return!1;if(e===">")return this.value=">",this.seal(),!0;throw'Expected ">", received "'+e+'"'},seal:function(){this.sealed=!0}},r=function(e){var t,n,r;r="";while(e.length){t=e.indexOf("<!--"),n=e.indexOf("-->");if(t===-1&&n===-1){r+=e;break}if(t!==-1&&n===-1)throw"Illegal HTML - expected closing comment sequence ('-->')";if(n!==-1&&t===-1||n<t)throw"Illegal HTML - unexpected closing comment sequence ('-->')";r+=e.substr(0,t),e=e.substring(n+3)}return r},t=e.types,n=/\s/,c={"#":t.SECTION,"^":t.INVERTED,"/":t.CLOSING,">":t.PARTIAL,"!":t.COMMENT}}(t),function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;e.compile=function(t,r){var i,s;return r=r||{},e.delimiters=r.delimiters||["{{","}}"],e.tripleDelimiters=r.tripleDelimiters||["{{{","}}}"],i=e.tokenize(t),s=n(i),s.toJson()},l=e.types,c=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],h=["a","abbr","acronym","address","applet","area","b","base","basefont","bdo","big","blockquote","body","br","button","caption","center","cite","code","col","colgroup","dd","del","dfn","dir","div","dl","dt","em","fieldset","font","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","hr","html","i","iframe","img","input","ins","isindex","kbd","label","legend","li","link","map","menu","meta","noframes","noscript","object","ol","optgroup","option","p","param","pre","q","s","samp","script","select","small","span","strike","strong","style","sub","sup","table","tbody","td","textarea","tfoot","th","thead","title","tr","tt","u","ul","var","article","aside","audio","bdi","canvas","command","data","datagrid","datalist","details","embed","eventsource","figcaption","figure","footer","header","hgroup","keygen","mark","meter","nav","output","progress","ruby","rp","rt","section","source","summary","time","track","video","wbr"],p=["li","dd","rt","rp","optgroup","option","tbody","tfoot","tr","td","th"],d={li:["li"],dt:["dt","dd"],dd:["dt","dd"],p:["address","article","aside","blockquote","dir","div","dl","fieldset","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","menu","nav","ol","p","pre","section","table","ul"],rt:["rt","rp"],rp:["rp","rt"],optgroup:["optgroup"],option:["option","optgroup"],thead:["tbody","tfoot"],tbody:["tbody","tfoot"],tr:["tr"],td:["td","th"],th:["td","th"]},f=function(e){var t,n,r,i,s;s=e.indexOf("[");if(s!==-1){n=e.substr(0,s),r=e.substring(s+1,e.length-1);try{i=JSON.parse(r)}catch(o){throw"Could not parse arguments ("+r+") using JSON.parse"}return{name:n,args:i}}return{name:e}},a={quot:34,amp:38,apos:39,lt:60,gt:62,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,copy:169,ordf:170,laquo:171,not:172,shy:173,reg:174,macr:175,deg:176,plusmn:177,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,sup1:185,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,Agrave:192,Aacute:193,Acirc:194,Atilde:195,Auml:196,Aring:197,AElig:198,Ccedil:199,Egrave:200,Eacute:201,Ecirc:202,Euml:203,Igrave:204,Iacute:205,Icirc:206,Iuml:207,ETH:208,Ntilde:209,Ograve:210,Oacute:211,Ocirc:212,Otilde:213,Ouml:214,times:215,Oslash:216,Ugrave:217,Uacute:218,Ucirc:219,Uuml:220,Yacute:221,THORN:222,szlig:223,agrave:224,aacute:225,acirc:226,atilde:227,auml:228,aring:229,aelig:230,ccedil:231,egrave:232,eacute:233,ecirc:234,euml:235,igrave:236,iacute:237,icirc:238,iuml:239,eth:240,ntilde:241,ograve:242,oacute:243,ocirc:244,otilde:245,ouml:246,divide:247,oslash:248,ugrave:249,uacute:250,ucirc:251,uuml:252,yacute:253,thorn:254,yuml:255,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,"int":8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},u=function(e){var t;return t=e.replace(/&([a-zA-Z]+);/,function(e,t){return a[t]?String.fromCharCode(a[t]):e}),t=t.replace(/&#x([0-9]+);/,function(e,t){return String.fromCharCode(parseInt(t,16))}),t=t.replace(/&#([0-9]+);/,function(e,t){return String.fromCharCode(t)}),t},r=function(e){this.text=e.value},r.prototype={toJson:function(){return this.decoded||(this.decoded=u(this.text))},toString:function(){return this.text},decodeCharacterReferences:function(){}},i=function(e,r){var i,s,o,u;this.type=l.ELEMENT,this.tag=e.tag,this.parentFragment=r,this.parentElement=r.parentElement,i=e.attributes.items,o=i.length;if(o){s=[];for(u=0;u<o;u+=1)s[u]={name:i[u].name.value,value:n(i[u].value.tokens,this.parentFragment.priority+1)};this.attributes=s}if(e.isSelfClosingTag||c.indexOf(e.tag.toLowerCase())!==-1)return;this.fragment=new t(this,r.priority+1)},i.prototype={read:function(e){return this.fragment&&this.fragment.read(e)},toJson:function(e){var t,n,r,i,s,o;t={type:l.ELEMENT,tag:this.tag};if(this.attributes){t.attrs={};for(s=0;s<this.attributes.length;s+=1)n=this.attributes[s].name,i=this.attributes[s].value.toString(),i!==!1?r=i:r=this.attributes[s].value.toJson(),t.attrs[n]=r}return this.fragment&&this.fragment.items.length&&(t.frag=this.fragment.toJson(e)),t},toString:function(){var e,t,n,r,i,s,o,u;if(h.indexOf(this.tag.toLowerCase())===-1)return!1;s=this.fragment?this.fragment.toString():"";if(s===!1)return!1;u=c.indexOf(this.tag.toLowerCase())!==-1,e="<"+this.tag;if(this.attributes)for(t=0,n=this.attributes.length;t<n;t+=1){if(this.attributes[t].name.indexOf(":")!==-1)return!1;r=" "+this.attributes[t].name,i=this.attributes[t].value.toString();if(i===!1)return!1;i!==""&&(r+="=",/[\s"'=<>`]/.test(i)?r+='"'+i.replace(/"/g,"&quot;")+'"':r+=i),e+=r}return this.isSelfClosing&&!u?(e+="/>",e):(e+=">",u?e:(e+=s,e+="</"+this.tag+">",e))}},s=function(e,n){this.type=l.SECTION,this.parentFragment=n,this.ref=e.ref,this.inverted=e.type===l.INVERTED,this.formatters=e.formatters,this.fragment=new t(this,n.priority+1)},s.prototype={read:function(e){return this.fragment.read(e)},toJson:function(e){var t;return t={type:l.SECTION,ref:this.ref,frag:this.fragment.toJson(e)},this.formatters&&this.formatters.length&&(t.fmtrs=this.formatters.map(f)),this.inverted&&(t.inv=!0),this.priority&&(t.p=this.parentFragment.priority),t},toString:function(){return!1}},o=function(e,t){this.type=e.type,this.priority=t,this.ref=e.ref,this.formatters=e.formatters},o.prototype={toJson:function(){var e={type:this.type,ref:this.ref};return this.formatters&&(e.fmtrs=this.formatters.map(f)),this.priority&&(e.p=this.priority),e},toString:function(){return!1}},t=function(e,t){this.owner=e,this.items=[],e&&(this.parentElement=e.type===l.ELEMENT?e:e.parentElement),this.priority=t},t.prototype={read:function(e){if(this.sealed)return!1;if(this.isImplicitlyClosedBy(e))return this.seal(),!1;if(this.currentChild){if(this.currentChild.read(e))return!0;this.currentChild=null}return this.isExplicitlyClosedBy(e)?(this.seal(),!0):e.type===l.CLOSING||e.type===l.DELIMCHANGE||e.type===l.COMMENT?!1:e.type===l.SECTION||e.type===l.INVERTED?(this.currentChild=new s(e,this),this.items[this.items.length]=this.currentChild,!0):e.type===l.TAG?(this.currentChild=new i(e,this),this.items[this.items.length]=this.currentChild,!0):e.type===l.TEXT||e.type===l.ATTR_VALUE_TOKEN?(this.items[this.items.length]=new r(e),!0):(this.items[this.items.length]=new o(e,this.priority),!0)},isClosedBy:function(e){return this.isImplicitlyClosedBy(e)||this.isExplicitlyClosedBy(e)},isImplicitlyClosedBy:function(e){var t,n,r,i,s;if(!e.tag||!this.owner||this.owner.type!==l.ELEMENT)return!1;i=this.owner.tag.toLowerCase(),s=e.tag.toLowerCase(),n=this.owner,r=n.parentElement||null,t=d[i];if(t&&!e.isClosingTag&&t.indexOf(s)!==-1)return!0;if(p.indexOf(i)!==-1&&r&&r.fragment.isClosedBy(e))return!0;if(i==="p"&&r&&r.tag.toLowerCase()==="a"&&r.fragment.isClosedBy(e))return!0},isExplicitlyClosedBy:function(e){if(!this.owner)return!1;if(this.owner.type===l.SECTION&&e.type===l.CLOSING&&e.ref===this.owner.ref)return!0;if(this.owner.type===l.ELEMENT&&this.owner&&e.isClosingTag&&e.tag.toLowerCase()===this.owner.tag.toLowerCase())return!0},toJson:function(e){var t=[],n,r,i;if(!e){i=this.toString();if(i!==!1)return i}for(n=0,r=this.items.length;n<r;n+=1)t[n]=this.items[n].toJson(e);return t},toString:function(){var e="",t,n,r;for(t=0,n=this.items.length;t<n;t+=1){r=this.items[t].toString();if(r===!1)return!1;e+=r}return e},seal:function(){this.sealed=!0}},n=function(e,n){var r=new t(null,n||0),i;while(e.length)i=e.shift(),r.read(i);return r}}(t),function(e){var t,n;e.ViewModel=function(e){this.data=e||{},this.pendingResolution=[],this.observers={}},e.ViewModel.prototype={set:function(e,n){var r,i,s,o,u,a,f;if(typeof e=="object"){for(r in e)e.hasOwnProperty(r)&&this.set(r,e[r]);return}i=t(e),o=this.data;while(i.length>1)s=i.shift(),o=o[s]||{};s=i[0],o[s]=n,this._notifyObservers(e,n),u=this.pendingResolution.length;while(u--)a=this.pendingResolution.splice(u,1)[0],f=this.getFullKeypath(a.view.model.ref,a.view.contextStack),f!==undefined?a.callback(f):this.registerUnresolvedKeypath(a)},get:function(e){var n,r;if(!e)return undefined;n=t(e),r=this.data;while(n.length){r&&(r=r[n.shift()]);if(r===undefined)return r}return r},update:function(e){var t=this.get(e);this._notifyObservers(e,t)},registerView:function(e){var t=this,n,r,i;r=function(n){e.keypath=n,e.observerRefs=t.observe({keypath:n,priority:e.model.p||0,view:e}),i=t.get(n),e.model.fmtrs&&(console.log(e),i=e.anglebars._format(i,e.model.fmtrs)),e.update(i)},n=this.getFullKeypath(e.model.ref,e.contextStack),n===undefined?this.registerUnresolvedKeypath({view:e,callback:r}):r(n)},getFullKeypath:function(e,t){var n;if(e===".")return t[t.length-1];t=t.concat();while(t.length){n=t.pop();if(this.get(n+"."+e)!==undefined)return n+"."+e}if(this.get(e)!==undefined)return e},registerUnresolvedKeypath:function(e){this.pendingResolution[this.pendingResolution.length]=e},_notifyObservers:function(e,t){var n=this,r=this.observers[e]||[],i,s,o,u,a;for(i=0;i<r.length;i+=1){o=r[i];if(o)for(s=0;s<o.length;s+=1)u=o[s],e!==u.originalAddress?a=n.get(u.originalAddress):a=t,u.view&&(u.view.model.fmtrs&&(a=u.view.anglebars._format(a,u.view.model.fmtrs)),u.view.update(a)),u.callback&&u.callback(a)}},observe:function(e){var t=this,n,r=e.keypath,i=e.priority,s=[],o;if(arguments.length===2&&typeof arguments[0]=="string"&&typeof arguments[1]=="function")return this.observe({keypath:arguments[0],callback:arguments[1],priority:0});if(!e.keypath)return undefined;o=function(n){var o,u;o=t.observers[n]=t.observers[n]||[],o=o[i]=o[i]||[],u={originalAddress:r},e.view&&(u.view=e.view),e.callback&&(u.callback=e.callback),o[o.length]=u,s[s.length]={keypath:n,priority:i,observer:u}},n=e.keypath;while(n.lastIndexOf(".")!==-1)o(n),n=n.substr(0,n.lastIndexOf("."));return o(n),s},unobserve:function(e){var t,n,r;t=this.observers[e.keypath];if(!t)return;n=t[e.priority];if(!n)return;if(n.indexOf)r=n.indexOf(e.observer);else for(var i=0,s=n.length;i<s;i+=1)if(n[i]===e.observer){r=i;break}if(r===-1)return;n.splice(r,1),n.length===0&&delete t[e.priority],t.length===0&&delete this.observers[e.keypath]},unobserveAll:function(e){while(e.length)this.unobserve(e.shift())}},Array.prototype.filter?e.ViewModel.prototype.cancelKeypathResolution=function(e){this.pendingResolution=this.pendingResolution.filter(function(t){return t.view!==e})}:e.ViewModel.prototype.cancelKeypathResolution=function(e){var t,n=[];for(t=0;t<this.pendingResolution.length;t+=1)this.pendingResolution[t].view!==e&&(n[n.length]=this.pendingResolution[t]);this.pendingResolution=n},t=function(e){var t,r=[],i;t=e.split(".");for(i=0;i<t.length;i+=1)r=r.concat(n(t[i]));return r},n=function(t){var n,r,i,s,o;n=t.indexOf("[");if(n===-1)return t;o=[t.substr(0,n)],r=t.substring(n),i=e.patterns.arrayPointer;while(r.length){s=i.exec(r);if(!s)return o;o[o.length]=+s[1],r=r.substring(s[0].length)}return o}}(t),function(e){var t,n,r,i,s,o,u;r=e.types,i=[],i[r.TEXT]="Text",i[r.INTERPOLATOR]="Interpolator",i[r.TRIPLE]="Triple",i[r.SECTION]="Section",i[r.ELEMENT]="Element",i[r.PARTIAL]="Partial",o=e.isArray,u=e.isObject,s=function(e,t,n){var r,i,s,o=[];n=n||null,r=document.createElement("div"),r.innerHTML=e,s=r.childNodes.length;for(i=0;i<s;i+=1)o[i]=r.childNodes[i];for(i=0;i<s;i+=1)t.insertBefore(o[i],n);return o},t=function(e){var t;return t=function(e){this.model=e.model,this.anglebars=e.anglebars,this.viewmodel=e.anglebars.viewmodel,this.parentNode=e.parentNode,this.parentFragment=e.parentFragment,this.contextStack=e.contextStack||[],this.anchor=e.anchor,this.index=e.index,this.type=e.model.type,this.initialize(),this.viewmodel.registerView(this),!this.keypath&&this.model.inverted&&this.update(!1)},t.prototype=e,t},n=e.DomViews={create:function(e){return typeof e.model=="string"?new n.Text(e):new n[i[e.model.type]](e)}},n.Fragment=function(e,t){var r,i,o,u;if(typeof e.model=="string"){this.nodes=s(e.model,e.parentNode,e.anchor);return}u=e.anglebars.async,this.owner=e.owner,this.index=e.index,u||(o={anglebars:e.anglebars,parentNode:e.parentNode,contextStack:e.contextStack,anchor:e.anchor,parentFragment:this}),this.items=[],this.queue=[],r=e.model.length;for(i=0;i<r;i+=1)u?(o={index:i,model:e.model[i],anglebars:e.anglebars,parentNode:e.parentNode,contextStack:e.contextStack,anchor:e.anchor,parentFragment:this},this.queue[this.queue.length]=o):(o.model=e.model[i],o.index=i,this.items[i]=n.create(o));u&&!t&&(e.anglebars.queue(this.queue),delete this.queue)},n.Fragment.prototype={teardown:function(){var e;if(this.nodes)while(this.nodes.length)e=this.nodes.pop(),e.parentNode.removeChild(e);while(this.items.length)this.items.pop().teardown()},firstNode:function(){return this.items[0]?this.items[0].firstNode():this.parentSection?this.parentSection.findNextNode(this):null},findNextNode:function(e){var t;return t=e.index,this.items[t+1]?this.items[t+1].firstNode():this.parentSection?this.parentSection.findNextNode(this):null}},n.Partial=function(e){var t;this.fragment=new n.Fragment({model:e.anglebars.compiledPartials[e.model.id]||[],anglebars:e.anglebars,parentNode:e.parentNode,contextStack:e.contextStack,anchor:e.anchor,owner:this})},n.Partial.prototype={teardown:function(){this.fragment.teardown()}},n.Text=function(e){this.node=document.createTextNode(e.model),this.index=e.index,this.anglebars=e.anglebars,this.parentNode=e.parentNode,this.parentNode.insertBefore(this.node,e.anchor||null)},n.Text.prototype={teardown:function(){this.anglebars.el.contains(this.node)&&this.parentNode.removeChild(this.node)},firstNode:function(){return this.node}},n.Element=function(e){var t,r,i,s,o,u;r=this.model=e.model,this.anglebars=e.anglebars,this.viewmodel=e.anglebars.viewmodel,this.parentFragment=e.parentFragment,this.parentNode=e.parentNode,this.index=e.index;if(r.attrs&&r.attrs.xmlns){i=r.attrs.xmlns;if(typeof i!="string")throw"Namespace attribute cannot contain mustaches"}else i=this.parentNode.namespaceURI;this.node=document.createElementNS(i,r.tag),this.attributes=[];for(o in r.attrs)r.attrs.hasOwnProperty(o)&&(u=r.attrs[o],s=new n.Attribute({owner:this,name:o,value:u,anglebars:e.anglebars,parentNode:this.node,contextStack:e.contextStack}),o==="value"&&this.anglebars.twoway&&(r.tag.toLowerCase()==="input"||r.tag.toLowerCase()==="textarea")&&(t=s),this.attributes[this.attributes.length]=s);t&&this.bind(t,e.anglebars.lazy),r.frag&&(typeof r.frag=="string"?this.node.innerHTML=r.frag:this.children=new n.Fragment({model:r.frag,anglebars:e.anglebars,parentNode:this.node,contextStack:e.contextStack,anchor:null,owner:this})),this.parentNode.insertBefore(this.node,e.anchor||null)},n.Element.prototype={bind:function(t,n){var r=this.viewmodel,i=this.node,s,o,u,a;o=!0;if(!t.children||t.children.length!==1||t.children[0].type!==e.types.INTERPOLATOR||t.children[0].model.formatters&&t.children[0].model.formatters.length)throw"Not a valid two-way data binding candidate - must be a single interpolator with no formatters";u=t.children[0],a=u.keypath||u.model.partialKeypath,s=function(){var e=i.value;e==="0"?e=0:e!==""&&(e=+e||e),r.set(a,e)},s(),i.addEventListener("change",s),n||i.addEventListener("keyup",s)},teardown:function(){this.anglebars.el.contains(this.node)&&this.parentNode.removeChild(this.node),this.children&&this.children.teardown();while(this.attributes.length)this.attributes.pop().teardown()},firstNode:function(){return this.node}},n.Attribute=function(t){var n,r,i,s,o,u,a;r=t.name,i=t.value,s=r.indexOf(":");if(s!==-1){o=r.substr(0,s);if(o==="xmlns")u=null;else{a=t.parentNode;while(a&&!u)u=a.getAttribute("xmlns:"+o),a=a.parentNode||t.owner.parentFragment.owner.node||t.owner.parentFragment.owner.parentNode}u&&(this.namespace=u)}if(typeof i=="string"){u?t.parentNode.setAttributeNS(u,r.replace(o+":",""),i):t.parentNode.setAttribute(r,i);return}this.parentNode=t.parentNode,this.name=r,this.children=[],n=i.length;while(n--)this.children[n]=e.TextViews.create({model:i[n],anglebars:t.anglebars,parent:this,contextStack:t.contextStack});this.update()},n.Attribute.prototype={teardown:function(){if(!this.children)return;while(this.children.length)this.children.pop().teardown()},bubble:function(){this.update()},update:function(){var e=this.value;this.value=this.toString(),this.value!==e&&(this.namespace?this.parentNode.setAttributeNS(this.namespace,this.name,this.value):this.parentNode.setAttribute(this.name,this.value))},toString:function(){return this.children.join("")}},n.Interpolator=t({initialize:function(){this.node=document.createTextNode(""),this.parentNode.insertBefore(this.node,this.anchor||null)},teardown:function(){this.observerRefs?this.viewmodel.unobserveAll(this.observerRefs):this.viewmodel.cancelKeypathResolution(this),this.anglebars.el.contains(this.node)&&this.parentNode.removeChild(this.node)},update:function(e){e!==this.text&&(this.text=e,this.node.data=e)},firstNode:function(){return this.node}}),n.Triple=t({initialize:function(){this.nodes=[]},teardown:function(){if(this.anglebars.el.contains(this.parentNode))while(this.nodes.length)this.parentNode.removeChild(this.nodes.pop());this.observerRefs?this.viewmodel.unobserveAll(this.observerRefs):this.viewmodel.cancelKeypathResolution(this)},firstNode:function(){return this.nodes[0]?this.nodes[0]:this.parentFragment.findNextNode(this)},update:function(e){var t;if(e===this.html)return;this.html=e;while(this.nodes.length)this.parentNode.removeChild(this.nodes.pop());t=this.anchor||this.parentFragment.findNextNode(this),this.nodes=s(e,this.parentNode,t)}}),n.Section=t({initialize:function(){this.views=[],this.length=0},teardown:function(){this.unrender(),this.observerRefs?this.viewmodel.unobserveAll(this.observerRefs):this.viewmodel.cancelKeypathResolution(this)},firstNode:function(){return this.views[0]?this.views[0].firstNode():this.parentFragment.findNextNode(this)},findNextNode:function(e){return this.views[e.index+1]?this.views[e.index+1].firstNode():this.parentFragment.findNextNode(this)},unrender:function(){while(this.views.length)this.views.shift().teardown()},update:function(e){var t,r,i,s,a;this.anglebars.async&&(this.queue=[]),a={model:this.model.frag,anglebars:this.anglebars,parentNode:this.parentNode,anchor:this.parentFragment.findNextNode(this),owner:this},o(e)&&e.length===0&&(t=!0);if(this.model.inverted){if(e&&!t){if(this.length){this.unrender(),this.length=0;return}}else if(!this.length){s=this.parentFragment.findNextNode(this),a.contextStack=this.contextStack,a.index=0,this.views[0]=new n.Fragment(a),this.length=1;return}return}if(o(e)){if(e.length<this.length){i=this.views.splice(e.length,this.length-e.length);while(i.length)i.pop().teardown()}else if(e.length>this.length){for(r=this.length;r<e.length;r+=1)a.contextStack=this.contextStack.concat(this.keypath+"."+r),a.index=r,this.views[r]=new n.Fragment(a,!0),this.anglebars.async&&(this.queue=this.queue.concat(this.views[r].queue));this.anglebars.async&&this.anglebars.queue(this.queue)}this.length=e.length}else u(e)?this.length||(a.contextStack=this.contextStack.concat(this.keypath),a.index=0,this.views[0]=new n.Fragment(a),this.length=1):e&&!t?this.length||(a.contextStack=this.contextStack,a.index=0,this.views[0]=new n.Fragment(a),this.length=1):this.length&&(this.unrender(),this.length=0)}})}(t),function(e){var t,n,r,i,s,o;r=e.types,i=[],i[r.TEXT]="Text",i[r.INTERPOLATOR]="Interpolator",i[r.TRIPLE]="Triple",i[r.SECTION]="Section",s=e.isArray,o=e.isObject,t=function(e){var t;return t=function(e){this.model=e.model,this.anglebars=e.anglebars,this.viewmodel=e.anglebars.viewmodel,this.parent=e.parent,this.contextStack=e.contextStack||[],this.type=e.model.type,this.initialize&&this.initialize(),this.viewmodel.registerView(this),!this.keypath&&this.model.inverted&&this.update(!1)},t.prototype=e,t},n=e.TextViews={create:function(e){return typeof e.model=="string"?new n.Text(e.model):new n[i[e.model.type]](e)}},n.Fragment=function(e){var t,r,i;this.parent=e.parent,this.items=[],i={anglebars:e.anglebars,parent:this,contextStack:e.contextStack},t=e.models?e.models.length:0;for(r=0;r<t;r+=1)i.model=this.models[r],this.items[this.items.length]=n.create(i);this.value=this.items.join("")},n.Fragment.prototype={bubble:function(){this.value=this.items.join(""),this.parent.bubble()},teardown:function(){var e,t;e=this.items.length;for(t=0;t<e;t+=1)this.items[t].teardown()},toString:function(){return this.value===undefined?"":this.value}},n.Text=function(e){this.text=e},n.Text.prototype={toString:function(){return this.text},teardown:function(){}},n.Interpolator=t({update:function(e){this.value=e,this.parent.bubble()},bubble:function(){this.parent.bubble()},teardown:function(){this.observerRefs?this.viewmodel.unobserveAll(this.observerRefs):this.viewmodel.cancelKeypathResolution(this)},toString:function(){return this.value===undefined?"":this.value}}),n.Triple=n.Interpolator,n.Section=t({initialize:function(){this.children=[],this.length=0},teardown:function(){this.unrender(),this.observerRefs?this.viewmodel.unobserveAll(this.observerRefs):this.viewmodel.cancelKeypathResolution(this)},unrender:function(){while(this.children.length)this.children.shift().teardown();this.length=0},bubble:function(){this.value=this.children.join(""),this.parent.bubble()},update:function(e){var t,r,i;s(e)&&e.length===0&&(t=!0);if(this.model.inverted){e&&!t?this.length&&(this.unrender(),this.length=0):this.length||(this.children[0]=new n.Fragment(this.model.frag,this.anglebars,this,this.contextStack),this.length=1),this.value=this.children.join(""),this.parent.bubble();return}if(typeof e=="object")if(s(e)){if(e.length<this.length){i=this.children.splice(e.length,this.length-e.length);while(i.length)i.shift().teardown()}else{for(r=0;r<this.length;r+=1)this.viewmodel.update(this.keypath+"."+r);if(e.length>this.length)for(r=this.length;r<e.length;r+=1)this.children[r]=new n.Fragment(this.model.frag,this.anglebars,this,this.contextStack.concat(this.keypath+"."+r))}this.length=e.length}else this.length||(this.children[0]=new n.Fragment(this.model.frag,this.anglebars,this,this.contextStack.concat(this.keypath)),this.length=1);else e&&!t?this.length||(this.children[0]=new n.Fragment(this.model.frag,this.anglebars,this,this.contextStack),this.length=1):this.length&&(this.unrender(),this.length=0);this.value=this.children.join(""),this.parent.bubble()},toString:function(){return this.value===undefined?"":this.value}})}(t),typeof module!="undefined"&&module.exports?module.exports=t:typeof define=="function"&&define.amd?define(function(){return t}):e.Anglebars=t})(this);