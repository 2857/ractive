/*! Anglebars - v0.0.1 - 2012-09-28
* http://rich-harris.github.com/Anglebars/
* Copyright (c) 2012 Rich Harris; Licensed WTFPL */
var Anglebars=function(){"use strict";var a,b;return a=function(a){this.initialize(a)},a.views={},a.substrings={},a.utils={},b=a.utils,a.prototype={initialize:function(c){var d;c=c||{},this.el=b.getEl(c.el),d=b.getEl(c.template),d?this.template=d.innerHTML:this.template=c.template,c.data&&(c.data instanceof a.Data?this.data=c.data:this.data=new a.Data(c.data)),this.formatters=c.formatters,this.preserveWhitespace=c.preserveWhitespace,this.replaceSrcAttributes=c.replaceSrcAttributes===undefined?!0:c.replaceSrcAttributes,this.compiled=a.compileTemplate(this.template,this.preserveWhitespace,this.replaceSrcAttributes),this.el.innerHTML="",this.render()},render:function(c){c=c?b.getEl(c):this.el;if(!c)throw new Error("You must specify a DOM element to render to");this.rendered=a.render(this,c)},set:function(){return this.data.set.apply(this.data,arguments),this},get:function(){return this.data.get.apply(this.data,arguments)},update:function(){return this.data.update.apply(this.data,arguments),this},format:function(a,b){var c,d,e;d=b.length;for(c=0;c<d;c+=1)e=b[c],this.formatters[e]&&(a=this.formatters[e](a));return a}},a}();(function(a){"use strict";var b=a.utils;a.Data=function(a){var b;this.data={};for(b in a)a.hasOwnProperty(b)&&(this.data[b]=a[b]);this.pendingResolution=[],this.subscriptions={}},a.Data.prototype={set:function(a,c){var d,e,f,g,h,i,j,k,l,m,n;if(typeof a=="object")for(d in a)a.hasOwnProperty(d)&&this.set(d,a[d]);else{n=this.get(a),e=a.split("."),g=this.data;while(e.length>1)f=e.shift(),g=g[f]||{};f=e[0],g[f]=c,b.isEqual(n,c)||this.publish(a,c)}h=this.pendingResolution.length;while(h--)k=this.pendingResolution.splice(h,1)[0],this.getAddress(k.item,k.item.keypath,k.item.contextStack,k.callback)},get:function(a){var b,c;if(!a)return"";b=a.split("."),c=this.data;while(b.length){c=c[b.shift()];if(c===undefined)return""}return c},update:function(a){var b=this.get(a);this.publish(a,b)},getAddress:function(a,b,c,d){var e,f,g,h,i,j;c=c?c.concat():[],i=c.concat();while(c){g=c.length?c[c.length-1]:null,e=g?g.split(".").concat(b.split(".")):b.split("."),f=e.concat(),h=this.data;while(e.length){h=h[e.shift()];if(h===undefined)break}if(h!==undefined){j=f.join("."),a.address=j,d.call(a,j);break}c.length?c.pop():c=!1}h===undefined&&this.registerUnresolvedAddress(a,d)},registerUnresolvedAddress:function(a,b){this.pendingResolution[this.pendingResolution.length]={item:a,callback:b}},cancelAddressResolution:function(a){this.pendingResolution=this.pendingResolution.filter(function(b){return b.item!==a})},publish:function(a,b){var c=this,d=this.subscriptions[a]||[],e,f,g,h;for(e=0;e<d.length;e+=1){g=d[e];if(g)for(f=0;f<g.length;f+=1)h=g[f],a!==h.originalAddress&&(b=c.get(h.originalAddress)),h.callback(b)}},subscribe:function(a,b,c){var d=this,e=a,f=[],g;if(!a)return undefined;g=function(a){var g,h;g=d.subscriptions[a]=d.subscriptions[a]||[],g=g[b]=g[b]||[],h={callback:c,originalAddress:e},g[g.length]=h,f[f.length]={address:a,level:b,subscription:h}};while(a.lastIndexOf(".")!==-1)g(a),a=a.substr(0,a.lastIndexOf("."));return g(a),f},unsubscribe:function(a){var b,c,d;b=this.subscriptions[a.address];if(!b)return;c=b[a.level];if(!c)return;d=c.indexOf(a.subscription);if(d===-1)return;c.splice(d,1),c.length===0&&delete b[a.level],b.length===0&&delete this.subscriptions[a.address]},unsubscribeAll:function(a){while(a.length)this.unsubscribe(a.shift())}}})(Anglebars),function(a){"use strict";var b=a.utils,c=a.views;a.compileTemplate=function(a,c,d){var e,f,g=[];return a=b.stripComments(a),e=b.getNodeArrayFromHtml(a,d),f=b.getStubsFromNodes(e),g=b.compileStubs(f,0),g},a.render=function(a,b){var d;if(!a.compiled)throw new Error("No compiled template");return d=new c.Fragment(a.compiled,a,b),d}}(Anglebars),function(a,b){"use strict",a.Attribute=function(a,c,d,e,f){var g,h,i;if(!a.isDynamic){d.setAttribute(a.name,a.value);return}this.node=d,this.name=a.name,this.data=c.data,this.substrings=[],h=a.components.length;for(g=0;g<h;g+=1)i=a.components[g],this.substrings[g]=b.create(i,c,this,e);this.update()},a.Attribute.prototype={teardown:function(){var a,b,c;a=this.substrings.length;for(b=0;b<a;b+=1)c=this.substrings[b],c.teardown&&c.teardown()},bubble:function(){this.update()},update:function(){this.value=this.toString(),this.node.setAttribute(this.name,this.value)},toString:function(){var a="",b,c,d;c=this.substrings.length;for(b=0;b<c;b+=1)d=this.substrings[b],a+=d.toString();return a}}}(Anglebars.views,Anglebars.substrings),function(a){"use strict",a.create=function(b,c,d,e,f){switch(b.type){case"text":return new a.Text(b,d,f);case"interpolator":return new a.Interpolator(b,c,d,e,f);case"triple":return new a.Triple(b,c,d,e,f);case"element":return new a.Element(b,c,d,e,f);case"section":return new a.Section(b,c,d,e,f)}}}(Anglebars.views),function(a,b,c){"use strict",a.Element=function(b,d,e,f,g){var h=d.data,i,j,k,l,m;this.data=h,b.namespace?this.node=c.createElementNS(b.namespace,b.tag):this.node=c.createElement(b.tag),this.attributes=[],j=b.attributes.length;for(i=0;i<j;i+=1)l=b.attributes[i],this.attributes[i]=new a.Attribute(l,d,this.node,f);if(b.children){this.children=[],k=b.children.length;for(i=0;i<k;i+=1)m=b.children[i],this.children[i]=a.create(m,d,this.node,f)}e.insertBefore(this.node,g||null)},a.Element.prototype={teardown:function(){var a,c;a=this.attributes.length;for(c=0;c<a;c+=1)this.attributes[c].teardown();b.remove(this.node)}}}(Anglebars.views,Anglebars.utils,document),function(a){"use strict",a.Fragment=function(b,c,d,e,f){var g,h;this.items=[],g=b.length;for(h=0;h<g;h+=1)this.items[this.items.length]=a.create(b[h],c,d,e,f)},a.Fragment.prototype={teardown:function(){var a,b;b=this.items.length;for(a=0;a<b;a+=1)this.items[a].teardown();delete this.items}}}(Anglebars.views),function(a,b,c){"use strict",a.Interpolator=function(a,b,d,e,f){var g=this,h,i,j=b.data;e=e?e.concat():[],this.node=c.createTextNode(""),this.data=j,this.keypath=a.keypath,this.contextStack=e,j.getAddress(this,a.keypath,e,function(c){h=j.get(c),i=b.format(h,a.formatters),this.update(i),this.subscriptionRefs=j.subscribe(c,a.level,function(c){var d=b.format(c,a.formatters);g.update(d)})}),d.insertBefore(this.node,f||null)},a.Interpolator.prototype={teardown:function(){this.subscriptionRefs?this.data.unsubscribeAll(this.subscriptionRefs):this.data.cancelAddressResolution(this),b.remove(this.node)},update:function(a){this.node.data=a}}}(Anglebars.views,Anglebars.utils,document),function(a,b){"use strict",a.Section=function(a,c,d,e,f){var g=this,h,i,j=c.data;this.model=a,this.contextStack=e||[],this.anglebars=c,this.data=j,this.views=[],this.parentNode=d,this.anchor=b.createAnchor(),d.insertBefore(this.anchor,f||null),j.getAddress(this,a.keypath,e,function(b){h=j.get(b),i=c.format(h,a.formatters),this.update(i),this.subscriptionRefs=j.subscribe(b,a.level,function(b){var d=c.format(b,a.formatters);g.update(d)})})},a.Section.prototype={teardown:function(){this.unrender(),this.subscriptionRefs?this.data.unsubscribeAll(this.subscriptionRefs):this.data.cancelAddressResolution(this),b.remove(this.anchor)},unrender:function(){while(this.views.length)this.views.shift().teardown()},update:function(c){var d,e;b.isArray(c)&&c.length===0&&(d=!0);if(this.model.inverted){if(c&&!d){if(this.rendered){this.unrender(),this.rendered=!1;return}}else if(!this.rendered){this.views[0]=new a.Fragment(this.model.children,this.anglebars,this.parentNode,this.contextStack,this.anchor),this.rendered=!0;return}return}switch(typeof c){case"object":this.rendered&&(this.unrender(),this.rendered=!1);if(b.isArray(c)){if(d)return;for(e=0;e<c.length;e+=1)this.views[e]=new a.Fragment(this.model.children,this.anglebars,this.parentNode,this.contextStack.concat(this.address+"."+e),this.anchor)}else this.views[0]=new a.Fragment(this.model.children,this.anglebars,this.parentNode,this.contextStack.concat(this.address),this.anchor);this.rendered=!0;break;default:c&&!d?this.rendered||(this.views[0]=new a.Fragment(this.model.children,this.anglebars,this.parentNode,this.contextStack,this.anchor),this.rendered=!0):this.rendered&&(this.unrender(),this.rendered=!1)}}}}(Anglebars.views,Anglebars.utils),function(a,b,c){"use strict",a.Text=function(a,b,d){this.node=c.createTextNode(a.text),b.insertBefore(this.node,d||null)},a.Text.prototype={teardown:function(){b.remove(this.node)}}}(Anglebars.views,Anglebars.utils,document),function(a,b){"use strict",a.Triple=function(a,c,d,e,f){var g=this,h,i,j=c.data;this.nodes=[],this.data=j,this.anglebars=c,this.anchor=b.createAnchor(),d.insertBefore(this.anchor,f||null),j.getAddress(this,a.keypath,e,function(b){this.subscriptionRefs=j.subscribe(b,a.level,function(b){var d=c.format(b,a.formatters);g.update(d)}),h=j.get(b),i=c.format(h,a.formatters),this.update(i)})},a.Triple.prototype={teardown:function(){var a,c;c=this.nodes.length;for(a=0;a<c;a+=1)b.remove(this.nodes[a]);this.subscriptionRefs?this.data.unsubscribeAll(this.subscriptionRefs):this.data.cancelAddressResolution(this),b.remove(this.anchor)},update:function(a){var c,d;if(b.isEqual(this.value,a))return;c=this.nodes.length;for(d=0;d<c;d+=1)b.remove(this.nodes[d]);this.nodes=b.getNodeArrayFromHtml(a,!1),c=this.nodes.length;for(d=0;d<c;d+=1)b.insertBefore(this.anchor,this.nodes[d])}}}(Anglebars.views,Anglebars.utils),function(a){"use strict",a.create=function(b,c,d,e){switch(b.type){case"text":return new a.Text(b,d);case"interpolator":case"triple":return new a.Interpolator(b,c,d,e);case"section":return new a.Section(b,c,d,e)}}}(Anglebars.substrings),function(a){"use strict",a.Fragment=function(b,c,d,e){var f,g,h;this.substrings=[],f=b.items.length;for(h=0;h<f;h+=1)g=a.create(b.items[h],c,this,e),this.substrings[h]=g;this.stringified=this.substrings.join("")},a.Fragment.prototype={bubble:function(){this.stringified=this.substrings.join(""),this.parent.bubble()},teardown:function(){var a,b;a=this.substrings.length;for(b=0;b<a;b+=1)this.substrings[b].teardown()},toString:function(){return this.stringified}}}(Anglebars.substrings),function(a,b){"use strict",a.Interpolator=function(a,b,c,d){this.parent=c,this.data=b.data,b.data.getAddress(this,a.keypath,d,function(c){var d,e,f=this;d=this.data.get(c),e=b.format(d,a.formatters),this.stringified=e,this.subscriptionRefs=this.data.subscribe(c,a.level,function(c){var d=b.format(c,a.formatters);f.stringified=d,f.bubble()})})},a.Interpolator.prototype={bubble:function(){this.parent.bubble()},teardown:function(){this.subscriptionRefs?this.data.unsubscribeAll(this.subscriptionRefs):this.data.cancelAddressResolution(this)},toString:function(){return this.stringified}},a.Triple=a.Interpolator}(Anglebars.substrings,Anglebars.utils),function(a){a.Section=function(a,b,c,d){this.contextStack=d,this.anglebars=b,this.data=b.data,this.substrings=[],this.data.getAddress(this,this.keypath,d,function(a){var b,c,d=this;b=this.data.get(this.address),c=this.anglebars.format(b,this.formatters),this.update(c),this.subscriptionRefs=this.data.subscribe(this.address,this.model.level,function(a){var b=d.anglebars.format(a,d.model.formatters);d.update(b),d.bubble()})})},a.Section.prototype={bubble:function(){this.parent.bubble()},teardown:function(){},update:function(b){var c,d;_.isArray(b)&&b.length===0&&(c=!0);if(this.model.inverted){if(b&&!c){if(this.rendered){this.substrings=[],this.rendered=!1;return}}else if(!this.rendered){this.substrings[0]=a.create(this.model.list,this.anglebars,this,this.contextStack),this.rendered=!0;return}return}switch(typeof b){case"object":this.rendered&&(this.substrings=[],this.rendered=!1);if(_.isArray(b)&&!c)for(d=0;d<b.length;d+=1)this.substrings[d]=this.model.list.getEvaluator(this,this.contextStack.concat(this.address+"."+d));else this.substrings[0]=this.section.list.render(this.parentNode,this.contextStack.concat(this.address),this.anchor);this.rendered=!0;break;default:b&&!c?this.rendered||(this.substrings[0]=this.model.list.getEvaluator(this,this.contextStack),this.rendered=!0):this.rendered&&(this.substrings=[],this.rendered=!1)}},toString:function(){return this.substrings.join("")}}}(Anglebars.substrings),function(a){"use strict",a.Text=function(a){this.text=a.text},a.Text.prototype={toString:function(){return this.text}}}(Anglebars.substrings),function(a,b){"use strict";var c=a.utils,d=/^\s+$/;c.insertBefore=function(a,b){if(!a)throw new Error("Can't insert before a non-existent node");return a.parentNode.insertBefore(b,a)},c.insertAfter=function(a,b){if(!a)throw new Error("Can't insert before a non-existent node");return a.parentNode.insertBefore(b,a.nextSibling)},c.remove=function(a){a.parentNode&&a.parentNode.removeChild(a)},c.trim=function(a){var b=a.replace(/^\s+/,"").replace(/\s+$/,"");return b},c.getNodeArrayFromHtml=function(a,c){var d,e,f,g,h,i=[],j,k;if(c){j=["src","poster"];for(g=0;g<j.length;g+=1)k=new RegExp("(<[^>]+\\s)("+j[g]+"=)","g"),a=a.replace(k,"$1data-anglebars-"+j[g]+"=")}b.implementation&&b.implementation.createDocument?(e=b.implementation.createDocument("http://www.w3.org/1999/xhtml","html",null),f=b.createElementNS("http://www.w3.org/1999/xhtml","body")):f=b.createElement("div"),f.innerHTML=a,h=f.childNodes.length;for(g=0;g<h;g+=1)i[g]=f.childNodes[g];return i},c.getEl=function(a){var c;if(a)if(typeof a=="string"){c=b.getElementById(a);if(!c&&b.querySelector)try{c=b.querySelector(a)}catch(d){}}else a[0]&&a[0].nodeType&&(c=a[0].innerHTML);return c},c.stripComments=function(a){var b=/\{\{!\s*[\s\S]+?\s*\}\}/g,c=/(^|\n|\r\n)\s*\{\{!\s*[\s\S]+?\s*\}\}\s*($|\n|\r\n)/g,d;return d=a.replace(c,function(a,b,c,d,e){return b}),d=d.replace(b,""),d},c.createAnchor=function(){var a=b.createElement("a");return a.setAttribute("class","anglebars-anchor"),a},c.nodeListToArray=function(a){var b,c=a.length,d=[];for(b=0;b<c;b+=1)d[b]=a[b];return d},c.attributeListToArray=function(a){var b,c=a.length,d=[];for(b=0;b<c;b+=1)d[b]={name:a[b].name,value:a[b].value};return d},c.findMustache=function(a,b){var d,e,f,g;f=/(\{)?\{\{(#|\^|\/)?(\>)?(&)?\s*([\s\S]+?)\s*\}\}(\})?/g,g=" | ",d=c.findMatch(a,f,b);if(d){d.formula=d[5],e=d.formula.split(g),d.keypath=e.shift(),d.formatters=e;if(d[2])d.type="section",d.inverted=d[2]==="^"?!0:!1,d.closing=d[2]==="/"?!0:!1;else if(d[3])d.type="partial";else if(d[1]){if(!d[6])return!1;d.type="triple"}else d.type="interpolator";return d.isMustache=!0,d}return!1},c.findMatch=function(a,b,c){var d;if(b.global)b.lastIndex=c||0;else throw new Error("You must pass findMatch() a regex with the global flag set");d=b.exec(a);if(d)return d.end=b.lastIndex,d.start=d.end-d[0].length,d},c.getStubsFromNodes=function(a){var b,d,e,f=[];d=a.length;for(b=0;b<d;b+=1)e=a[b],e.nodeType===1?f[f.length]={type:"element",original:e}:e.nodeType===3&&(f=f.concat(c.expandText(e.data)));return f},c.expandText=function(a){var b,d;return d=c.findMustache(a),d?(b=[],d.start>0&&(b[b.length]={type:"text",text:a.substr(0,d.start)}),b[b.length]={type:"mustache",mustache:d},d.end<a.length&&(b=b.concat(c.expandText(a.substring(d.end)))),b):{type:"text",text:a}},c.setText=function(a,b){a.textContent!==undefined?a.textContent=b:a.data=b},c.isEqual=function(a,b){var c=function(a,b,d){if(a===b)return a!==0||1/a==1/b;if(a==null||b==null)return a===b;var e=toString.call(a);if(e!=toString.call(b))return!1;switch(e){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if(typeof a!="object"||typeof b!="object")return!1;var f=d.length;while(f--)if(d[f]==a)return!0;d.push(a);var g=0,h=!0;if(e=="[object Array]"){g=a.length,h=g==b.length;if(h)while(g--)if(!(h=g in a==g in b&&c(a[g],b[g],d)))break}else{if("constructor"in a!="constructor"in b||a.constructor!=b.constructor)return!1;for(var i in a)if(a.hasOwnProperty(i)){g++;if(!(h=b.hasOwnProperty(i)&&c(a[i],b[i],d)))break}if(h){for(i in b)if(b.hasOwnProperty(i)&&!(g--))break;h=!g}}return d.pop(),h};return c(a,b,[])},c.isArray=function(a){return Object.prototype.toString.call(a)==="[object Array]"},c.compileStubs=function(a,b,e,f){var g,h,i;g=[],i=function(h){var i,j,k,l,m,n,o,p,q,r;m=a[h];switch(m.type){case"text":if(!f)if(d.test(m.text)||m.text==="")return h+1;return g[g.length]=m,h+1;case"element":return g[g.length]=c.processElementStub(m,b,e),h+1;case"mustache":r=m.mustache.keypath;switch(m.mustache.type){case"section":h+=1,n=h,p=1;while(h<a.length&&!o)q=a[h],q.type==="mustache"&&q.mustache.type==="section"&&q.mustache.keypath===r&&(q.mustache.closing?(p-=1,p||(o=h)):p+=1),h+=1;if(!o)throw new Error('Illegal section "'+r+'"');return g[g.length]={type:"section",keypath:r,formatters:m.mustache.formatters,inverted:m.mustache.inverted,children:c.compileStubs(a.slice(n,o),b+1,e,f),level:b},h;case"triple":return g[g.length]={type:"triple",keypath:m.mustache.keypath,formatters:m.mustache.formatters,level:b},h+1;case"interpolator":return g[g.length]={type:"interpolator",keypath:m.mustache.keypath,formatters:m.mustache.formatters,level:b},h+1;default:throw new Error("Error compiling template")}break;default:throw new Error("Error compiling template")}},h=0;while(h<a.length)h=i(h);return g},c.processElementStub=function(a,b,d){var e,f,g,h,i,j;j=a.original,e={type:"element",tag:j.tagName,level:b},d&&(e.namespace=d),f=[],g=j.attributes.length;for(i=0;i<g;i+=1)h=j.attributes[i],h.name==="xmlns"?e.namespace=h.value:f[f.length]=c.processAttribute(h.name,h.value,b+1);return e.attributes=f,e.children=c.compileStubs(c.getStubsFromNodes(j.childNodes),b+1,e.namespace),e},c.processAttribute=function(a,b,d){var e,f;return f=c.expandText(b),e={name:a.replace("data-anglebars-","")},c.findMustache(b)?(e.isDynamic=!0,e.level=d,e.components=c.compileStubs(f,d,null),e):(e.value=b,e)}}(Anglebars,document);