/*! Anglebars - v0.1.2 - 2013-01-08
* http://rich-harris.github.com/Anglebars/
* Copyright (c) 2013 Rich Harris; Licensed WTFPL */

/*jslint eqeq: true, plusplus: true */
/*global document, HTMLElement */

'use strict';


"use strict";var Anglebars=function(e){e=e||{},"el"in e&&(this.el=Anglebars.utils.getEl(e.el)),"compiled"in e&&(this.compiled=e.compiled),"template"in e&&(this.template=e.template),"partials"in e&&(this.partials=e.partials),this.compiledPartials="compiledPartials"in e?e.compiledPartials:{},this.viewmodel=e.data instanceof Anglebars.ViewModel?e.data:new Anglebars.ViewModel(e.data),this.formatters="formatters"in e?e.formatters:{},this.preserveWhitespace="preserveWhitespace"in e?e.preserveWhitespace:!1,this.replaceSrcAttributes="replaceSrcAttributes"in e?e.replaceSrcAttributes:!0,this.namespace=e.namespace?e.namespace:this.el&&this.el.namespaceURI!=="http://www.w3.org/1999/xhtml"?this.el.namespaceURI:null,this.async="async"in e?e.async:!1,this.maxBatch="maxBatch"in e?e.maxBatch:50,this.append="append"in e?e.append:!1,this.twoway="twoway"in e?e.twoway:!0;if(this.partials)for(var t in this.partials)this.partials.hasOwnProperty(t)&&(this.compiledPartials[t]=Anglebars.compile(this.partials[t],{preserveWhitespace:this.preserveWhitespace,replaceSrcAttributes:this.replaceSrcAttributes}));!this.compiled&&this.template&&(this.compiled=Anglebars.compile(this.template,{preserveWhitespace:this.preserveWhitespace,replaceSrcAttributes:this.replaceSrcAttributes,namespace:this.namespace,partials:this.compiledPartials})),this.compiled&&this.el&&this.render({el:this.el,callback:e.callback,append:this.append})};Anglebars.prototype={queue:function(e){this._queue=e.concat(this._queue||[]),this._dispatchingQueue||this.dispatchQueue()},dispatchQueue:function(){var e=this,t,n;n=this.maxBatch,t=function(){var r=+(new Date),i;while(e._queue.length&&new Date-r<n)i=e._queue.shift(),i.parentFragment.items[i.index]=Anglebars.DomViews.create(i);e._queue.length?Anglebars.utils.wait(t):(e._dispatchingQueue=!1,e.callback&&(e.callback(),delete e.callback),e.async=!1)},this._dispatchingQueue=!0,Anglebars.utils.wait(t)},render:function(e){var t=e.el?Anglebars.utils.getEl(e.el):this.el;if(!t)throw new Error("You must specify a DOM element to render to");e.append||(t.innerHTML=""),e.callback&&(this.callback=e.callback),this.rendered=new Anglebars.DomViews.Fragment({model:this.compiled,anglebars:this,parentNode:t}),!this.async&&e.callback&&e.callback()},teardown:function(){this.rendered.teardown()},set:function(){var e=this.el.style.display;return this.viewmodel.set.apply(this.viewmodel,arguments),this},get:function(){return this.viewmodel.get.apply(this.viewmodel,arguments)},update:function(){return this.viewmodel.update.apply(this.viewmodel,arguments),this},observe:function(){return this.viewmodel.observe.apply(this.viewmodel,arguments)},unobserve:function(){return this.viewmodel.unobserve.apply(this.viewmodel,arguments),this},_format:function(e,t){var n,r,i,s,o,u;if(!t)return e;r=t.length;for(n=0;n<r;n+=1)i=t[n],s=i.name,o=i.args||[],u=this.formatters[s]||Anglebars.formatters[s],u&&(e=u.apply(this,[e].concat(o)));return e}},Anglebars.compile=function(e,t){var n,r,i=[],s,o,u=Anglebars.utils;return t=t||{},Anglebars.delimiters=t.delimiters||["{{","}}"],Anglebars.tripleDelimiters=t.tripleDelimiters||["{{{","}}}"],Anglebars.utils.compileMustachePattern(),e=u.preProcess(e),n=u.getNodeArrayFromHtml(e,t.replaceSrcAttributes===undefined?!0:t.replaceSrcAttributes),r=u.getStubsFromNodes(n),i=u.compileStubs(r,0,t.preserveWhitespace),i},Anglebars.patterns={formatter:/([a-zA-Z_$][a-zA-Z_$0-9]*)(\[[^\]]*\])?/,preprocessorTypes:/section|comment|delimiterChange/,standalonePre:/(?:\r)?\n[ \t]*$/,standalonePost:/^[ \t]*(\r)?\n/,standalonePreStrip:/[ \t]+$/,arrayPointer:/\[([0-9]+)\]/},Anglebars.types={TEXT:0,INTERPOLATOR:1,TRIPLE:2,SECTION:3,ELEMENT:4,PARTIAL:5,COMMENT:6,DELIMCHANGE:7,MUSTACHE:8},Anglebars.formatters={equals:function(e,t){return e===t},greaterThan:function(e,t){return e>t},greaterThanEquals:function(e,t){return e>=t},lessThan:function(e,t){return e<t},lessThanEquals:function(e,t){return e<=t}},function(e){var t=e.types,n=e.utils={getNodeArrayFromHtml:function(e,t){var n,r,i,s=[],o,u,a;e=""+e;if(t){o=["src","poster"],r=o.length;while(r--)a=new RegExp("(<[^>]+\\s)("+o[r]+"=)","g"),e=e.replace(a,"$1data-anglebars-"+o[r]+"=")}var f=!0;if(f){u=["table","thead","tbody","tr","th","td"],r=u.length;while(r--)a=new RegExp("<("+u[r]+")(\\s|>)","gi"),e=e.replace(a,'<div data-anglebars-elementname="$1"$2'),a=new RegExp("<\\/"+u[r]+">","gi"),e=e.replace(a,"</div>")}n=document.createElement("div"),n.innerHTML=e,s=[],r=n.childNodes.length;while(r--)s[r]=n.childNodes[r];return s},getEl:function(e){var t;if(!e)throw new Error("No container element specified");if(e.tagName)return e;if(typeof e=="string"){t=document.getElementById(e);if(t.tagName)return t}throw new Error("Could not find container element")},splitKeypath:function(e){var t,r=[],i;t=e.split(".");for(i=0;i<t.length;i+=1)r=r.concat(n.parseArrayNotation(t[i]));return r},parseArrayNotation:function(t){var n,r,i,s,o;n=t.indexOf("[");if(n===-1)return t;o=[t.substr(0,n)],r=t.substring(n),i=e.patterns.arrayPointer;while(r.length){s=i.exec(r);if(!s)return o;o[o.length]=+s[1],r=r.substring(s[0].length)}return o},escape:function(e){var t=/[\[\]\(\)\{\}\^\$\*\+\?\.\|]/g;return e.replace(t,"\\$&")},compileMustachePattern:function(){var t=this.escape(e.delimiters[0]),n=this.escape(e.delimiters[1]),r=this.escape(e.tripleDelimiters[0]),i=this.escape(e.tripleDelimiters[1]);e.patterns.mustache=new RegExp("(?:("+r+")|("+t+"))"+"(?:(?:"+"(=)\\s*([^\\s]+)\\s+([^\\s]+)\\s*(=)"+"(?:("+i+")|("+n+"))"+")|(?:"+"(#|\\^|\\/)?"+"(\\>)?"+"(&)?"+"(!)?"+"\\s*"+"([\\s\\S]+?)"+"\\s*"+"(?:("+i+")|("+n+"))"+"))","g")},preProcess:function(r){var i="",s=r,o,u,a,f,l,c,h,p,d;h=e.delimiters.concat(),p=e.tripleDelimiters.concat(),f=/(?:\r)?\n\s*$/,l=/^\s*(?:\r)?\n/;while(s.length){o=n.findMustache(s);if(!o){i+=s;break}o.type===t.SECTION||o.type===t.COMMENT||o.type===t.DELIMCHANGE?(u=s.substr(0,o.start),a=s.substring(o.end),f.test(u)&&l.test(a)&&(u=u.replace(/(?:\r)?\n\s*$/,"")),i+=u,o.type!==t.COMMENT&&(i+=o[0]),s=a):(i+=s.substr(0,o.end),s=s.substring(o.end))}if(e.delimiters[0]!==h[0]||e.delimiters[1]!==h[1])e.delimiters=h,d=!0;if(e.tripleDelimiters[0]!==p[0]||e.tripleDelimiters[1]!==p[1])e.tripleDelimiters=p,d=!0;return d&&n.compileMustachePattern(),i},findMustache:function(r,i){var s,o,u,a,f,l,c,h,p,d;u=e.patterns.mustache,a=" | ",h=e.patterns.formatter,s=n.findMatch(r,u,i);if(s){if(s[3]&&s[6])s.type=t.DELIMCHANGE,s[1]&&s[7]?e.tripleDelimiters=[s[4],s[5]]:e.delimiters=[s[4],s[5]],n.compileMustachePattern();else{s.formula=s[13],o=s.formula.split(a),s.partialKeypath=o.shift(),l=[];for(f=0;f<o.length;f+=1){c=h.exec(o[f]);if(c){p={name:c[1]};if(c[2])try{p.args=JSON.parse(c[2])}catch(v){throw new Error("Illegal arguments for formatter '"+p.name+"': "+c[2]+" (JSON.parse() failed)")}l.push(p)}}l.length&&(s.formatters=l);if(s[9])s.type=t.SECTION,s.inverted=s[9]==="^"?!0:!1,s.closing=s[9]==="/"?!0:!1;else if(s[10])s.type=t.PARTIAL;else if(s[1]){if(!s[14])return!1;s.type=t.TRIPLE}else s[12]?s.type=t.COMMENT:s.type=t.INTERPOLATOR}return s.isMustache=!0,s}return!1},findMatch:function(e,t,n){var r;if(!t.global)throw new Error("You must pass findMatch() a regex with the global flag set");t.lastIndex=n||0,r=t.exec(e);if(r)return r.end=t.lastIndex,r.start=r.end-r[0].length,r},getStubsFromNodes:function(e){var r,i,s,o=[],u;i=e.length;for(r=0;r<i;r+=1)s=e[r],s.nodeType===1?o[o.length]={type:t.ELEMENT,original:s}:s.nodeType===3&&(u=n.expandText(s.data),u&&(o=o.concat(u)));return o},expandText:function(e){var r=[],i,s,o,u,a,f,l;i=n.findMustache(e);while(i.type===t.DELIMCHANGE)i.start>0&&(r[r.length]={type:t.TEXT,text:e.substr(0,i.start)}),e=e.substring(i.end),i=n.findMustache(e);return i?(f=!0,o=/\s*\n\s*$/,i.start>0&&(u=e.substr(0,i.start),r[r.length]={type:t.TEXT,text:u}),r[r.length]={type:t.MUSTACHE,mustache:i},i.end<e.length&&(l=n.expandText(e.substring(i.end)),l&&(r=r.concat(l))),r):e?r.concat({type:t.TEXT,text:e}):r.length?r:!1},isArray:function(e){return Object.prototype.toString.call(e)==="[object Array]"},isObject:function(e){return Object.prototype.toString.call(e)==="[object Object]"&&typeof e!="function"},compileStubs:function(e,r,i){var s,o,u;s=[],u=function(o){var u,a,f,l,c,h,p,d,v,m,g,y;u=/^\s*\n\r?\s*$/,h=e[o];switch(h.type){case t.TEXT:if(!i)if(u.test(h.text)||h.text==="")return o+1;return s[s.length]=h,o+1;case t.ELEMENT:return s[s.length]=n.processElementStub(h,r),o+1;case t.MUSTACHE:g=h.mustache.partialKeypath;switch(h.mustache.type){case t.SECTION:o+=1,p=o,v=1;while(o<e.length&&!d)m=e[o],m.type===t.MUSTACHE&&m.mustache.type===t.SECTION&&m.mustache.partialKeypath===g&&(m.mustache.closing?(v-=1,v||(d=o)):v+=1),o+=1;if(!d)throw new Error('Illegal section "'+g+'"');return y={type:t.SECTION,partialKeypath:g,inverted:h.mustache.inverted,children:n.compileStubs(e.slice(p,d),r+1,i),priority:r},h.mustache.formatters&&(y.formatters=h.mustache.formatters),s[s.length]=y,o;case t.TRIPLE:return y={type:t.TRIPLE,partialKeypath:h.mustache.partialKeypath,priority:r},h.mustache.formatters&&(y.formatters=h.mustache.formatters),s[s.length]=y,o+1;case t.INTERPOLATOR:return y={type:t.INTERPOLATOR,partialKeypath:h.mustache.partialKeypath,priority:r},h.mustache.formatters&&(y.formatters=h.mustache.formatters),s[s.length]=y,o+1;case t.PARTIAL:return y={type:t.PARTIAL,id:h.mustache.partialKeypath,priority:r},s[s.length]=y,o+1;default:throw console&&console.error&&console.error("Bad mustache: ",h.mustache),new Error("Error compiling template: Illegal mustache ("+h.mustache[0]+")")}break;default:throw new Error("Error compiling template. Something *very weird* has happened")}},o=0;while(o<e.length)o=u(o);return s},processElementStub:function(e,r){var i,s,o,u,a,f;f=e.original,i={type:t.ELEMENT,tag:f.getAttribute("data-anglebars-elementname")||f.localName||f.tagName,priority:r},s=[],o=f.attributes.length;for(a=0;a<o;a+=1){u=f.attributes[a];if(s.name==="data-anglebars-elementname")continue;u.name==="xmlns"?i.namespace=u.value:s[s.length]=n.processAttribute(u.name,u.value,r+1)}return i.attributes=s,i.children=n.compileStubs(n.getStubsFromNodes(f.childNodes),r+1),i},processAttribute:function(e,t,r){var i,s;return s=n.expandText(t),i={name:e.replace("data-anglebars-","")},!n.findMustache(t)||!s?(i.value=t,i):(i.isDynamic=!0,i.priority=r,i.components=n.compileStubs(s,r),i)}};(function(){var e=["ms","moz","webkit","o"],t,r;if(window.requestAnimationFrame){n.wait=function(e){window.requestAnimationFrame(e)};return}r=function(t){if(window[e[t]+"RequestAnimationFrame"]){n.wait=function(n){window[e[t]+"RequestAnimationFrame"](n)};return}};for(t=0;t<e.length;t+=1)r(t);n.wait=function(e){setTimeout(e,16)}})()}(Anglebars),function(e){e.ViewModel=function(e){this.data=e||{},this.pendingResolution=[],this.observers={}},e.ViewModel.prototype={set:function(t,n){var r,i,s,o,u,a,f;if(typeof t=="object"){for(r in t)t.hasOwnProperty(r)&&this.set(r,t[r]);return}i=e.utils.splitKeypath(t),o=this.data;while(i.length>1)s=i.shift(),o=o[s]||{};s=i[0],o[s]=n,this._notifyObservers(t,n),u=this.pendingResolution.length;while(u--)a=this.pendingResolution.splice(u,1)[0],f=this.getFullKeypath(a.view.model.partialKeypath,a.view.contextStack),f!==undefined?a.callback(f):this.registerUnresolvedKeypath(a)},get:function(t){var n,r;if(!t)return undefined;n=e.utils.splitKeypath(t),r=this.data;while(n.length){r&&(r=r[n.shift()]);if(r===undefined)return r}return r},update:function(e){var t=this.get(e);this._notifyObservers(e,t)},registerView:function(e){var t=this,n,r,i,s;r=function(n){e.keypath=n,e.observerRefs=t.observe({keypath:n,priority:e.model.priority,view:e}),i=t.get(n),s=e.anglebars._format(i,e.model.formatters),e.update(s)},n=this.getFullKeypath(e.model.partialKeypath,e.contextStack),n===undefined?this.registerUnresolvedKeypath({view:e,callback:r}):r(n)},getFullKeypath:function(e,t){var n;if(e===".")return t[t.length-1];t=t.concat();while(t.length){n=t.pop();if(this.get(n+"."+e)!==undefined)return n+"."+e}if(this.get(e)!==undefined)return e},registerUnresolvedKeypath:function(e){this.pendingResolution[this.pendingResolution.length]=e},_notifyObservers:function(e,t){var n=this,r=this.observers[e]||[],i,s,o,u,a,f;for(i=0;i<r.length;i+=1){o=r[i];if(o)for(s=0;s<o.length;s+=1)u=o[s],e!==u.originalAddress?f=n.get(u.originalAddress):f=t,u.view&&(a=u.view.anglebars._format(f,u.view.model.formatters),u.view.update(a)),u.callback&&u.callback(f)}},observe:function(e){var t=this,n,r=e.keypath,i=e.priority,s=[],o;if(arguments.length===2&&typeof arguments[0]=="string"&&typeof arguments[1]=="function")return this.observe({keypath:arguments[0],callback:arguments[1],priority:0});if(!e.keypath)return undefined;o=function(n){var o,u;o=t.observers[n]=t.observers[n]||[],o=o[i]=o[i]||[],u={originalAddress:r},e.view&&(u.view=e.view),e.callback&&(u.callback=e.callback),o[o.length]=u,s[s.length]={keypath:n,priority:i,observer:u}},n=e.keypath;while(n.lastIndexOf(".")!==-1)o(n),n=n.substr(0,n.lastIndexOf("."));return o(n),s},unobserve:function(e){var t,n,r;t=this.observers[e.keypath];if(!t)return;n=t[e.priority];if(!n)return;if(n.indexOf)r=n.indexOf(e.observer);else for(var i=0,s=n.length;i<s;i+=1)if(n[i]===e.observer){r=i;break}if(r===-1)return;n.splice(r,1),n.length===0&&delete t[e.priority],t.length===0&&delete this.observers[e.keypath]},unobserveAll:function(e){while(e.length)this.unobserve(e.shift())}},Array.prototype.filter?e.ViewModel.prototype.cancelKeypathResolution=function(e){this.pendingResolution=this.pendingResolution.filter(function(t){return t.view!==e})}:e.ViewModel.prototype.cancelKeypathResolution=function(e){var t,n=[];for(t=0;t<this.pendingResolution.length;t+=1)this.pendingResolution[t].view!==e&&(n[n.length]=this.pendingResolution[t]);this.pendingResolution=n}}(Anglebars),function(e){var t,n,r,i;r=e.types,i=[],i[r.TEXT]="Text",i[r.INTERPOLATOR]="Interpolator",i[r.TRIPLE]="Triple",i[r.SECTION]="Section",t=function(e){var t;return t=function(e){this.model=e.model,this.anglebars=e.anglebars,this.viewmodel=e.anglebars.viewmodel,this.parent=e.parent,this.contextStack=e.contextStack||[],this.type=e.model.type,this.initialize&&this.initialize(),this.viewmodel.registerView(this),!this.keypath&&this.model.inverted&&this.update(!1)},t.prototype=e,t},n=e.TextViews={create:function(e){return new n[i[e.model.type]](e)}},n.Fragment=function(e){var t,r,i;this.parent=e.parent,this.items=[],i={anglebars:e.anglebars,parent:this,contextStack:e.contextStack},t=e.models?e.models.length:0;for(r=0;r<t;r+=1)i.model=this.models[r],this.items[this.items.length]=n.create(i);this.value=this.items.join("")},n.Fragment.prototype={bubble:function(){this.value=this.items.join(""),this.parent.bubble()},teardown:function(){var e,t;e=this.items.length;for(t=0;t<e;t+=1)this.items[t].teardown()},toString:function(){return this.value===undefined?"":this.value}},n.Text=function(e){this.text=e.model.text},n.Text.prototype={toString:function(){return this.text},teardown:function(){}},n.Interpolator=t({update:function(e){this.value=e,this.parent.bubble()},bubble:function(){this.parent.bubble()},teardown:function(){this.observerRefs?this.viewmodel.unobserveAll(this.observerRefs):this.viewmodel.cancelKeypathResolution(this)},toString:function(){return this.value===undefined?"":this.value}}),n.Triple=n.Interpolator,n.Section=t({initialize:function(){this.children=[],this.length=0},teardown:function(){this.unrender(),this.observerRefs?this.viewmodel.unobserveAll(this.observerRefs):this.viewmodel.cancelKeypathResolution(this)},unrender:function(){while(this.children.length)this.children.shift().teardown();this.length=0},bubble:function(){this.value=this.children.join(""),this.parent.bubble()},update:function(t){var r,i,s;e.utils.isArray(t)&&t.length===0&&(r=!0);if(this.model.inverted){t&&!r?this.length&&(this.unrender(),this.length=0):this.length||(this.children[0]=new n.Fragment(this.model.children,this.anglebars,this,this.contextStack),this.length=1),this.value=this.children.join(""),this.parent.bubble();return}if(typeof t=="object")if(e.utils.isArray(t)){if(t.length<this.length){s=this.children.splice(t.length,this.length-t.length);while(s.length)s.shift().teardown()}else{for(i=0;i<this.length;i+=1)this.viewmodel.update(this.keypath+"."+i);if(t.length>this.length)for(i=this.length;i<t.length;i+=1)this.children[i]=new n.Fragment(this.model.children,this.anglebars,this,this.contextStack.concat(this.keypath+"."+i))}this.length=t.length}else this.length||(this.children[0]=new n.Fragment(this.model.children,this.anglebars,this,this.contextStack.concat(this.keypath)),this.length=1);else t&&!r?this.length||(this.children[0]=new n.Fragment(this.model.children,this.anglebars,this,this.contextStack),this.length=1):this.length&&(this.unrender(),this.length=0);this.value=this.children.join(""),this.parent.bubble()},toString:function(){return this.value===undefined?"":this.value}})}(Anglebars);