/*! Anglebars - v0.1.1 - 2012-11-16
* http://rich-harris.github.com/Anglebars/
* Copyright (c) 2012 Rich Harris; Licensed WTFPL */

/*jslint eqeq: true, plusplus: true */
/*global document, HTMLElement */

'use strict';


"use strict";var Anglebars=function(a){a=a||{},a.el!==undefined&&(this.el=Anglebars.utils.getEl(a.el)),a.compiled!==undefined&&(this.compiled=a.compiled),a.template!==undefined&&(this.template=a.template),a.partials!==undefined&&(this.partials=a.partials),this.viewmodel=a.data instanceof Anglebars.ViewModel?a.data:new Anglebars.ViewModel(a.data),a.formatters!==undefined&&(this.formatters=a.formatters),this.preserveWhitespace=a.preserveWhitespace===undefined?!1:a.preserveWhitespace,this.replaceSrcAttributes=a.replaceSrcAttributes===undefined?!0:a.replaceSrcAttributes,this.namespace=a.namespace?a.namespace:this.el&&this.el.namespaceURI!=="http://www.w3.org/1999/xhtml"?this.el.namespaceURI:null,!this.compiled&&this.template&&(this.compiled=Anglebars.compile(this.template,{preserveWhitespace:this.preserveWhitespace,replaceSrcAttributes:this.replaceSrcAttributes,namespace:this.namespace,partials:this.partials})),this.compiled&&this.el&&(this.el.innerHTML="",this.render())};Anglebars.prototype={render:function(a){a=a?Anglebars.utils.getEl(a):this.el;if(!a)throw new Error("You must specify a DOM element to render to");this.rendered=new Anglebars.views.Fragment({model:this.compiled,anglebars:this,parentNode:a})},teardown:function(){this.rendered.teardown(),this.el.innerHTML=""},set:function(){return this.viewmodel.set.apply(this.viewmodel,arguments),this},get:function(){return this.viewmodel.get.apply(this.viewmodel,arguments)},update:function(){return this.viewmodel.update.apply(this.viewmodel,arguments),this},_format:function(a,b){var c,d,e,f,g;d=b.length;for(c=0;c<d;c+=1)e=b[c],f=e.name,g=e.args||[],this.formatters[f]&&(a=this.formatters[f].apply(this,[a].concat(g)));return a}},function(a){"use strict";var b=a.utils={remove:function(a){a.parentNode&&a.parentNode.removeChild(a)},trim:function(a){var b=a.replace(/^\s+/,"").replace(/\s+$/,"");return b},getNodeArrayFromHtml:function(a,b){var c,d,e,f=[],g,h,i;a=""+a;if(b){g=["src","poster"];for(d=0;d<g.length;d+=1)i=new RegExp("(<[^>]+\\s)("+g[d]+"=)","g"),a=a.replace(i,"$1data-anglebars-"+g[d]+"=")}var j=!0;if(j){h=["table","thead","tbody","tr","th","td"];for(d=0;d<h.length;d+=1)i=new RegExp("<("+h[d]+")(\\s|>)","gi"),a=a.replace(i,'<div data-anglebars-elementname="$1"$2'),i=new RegExp("<\\/"+h[d]+">","gi"),a=a.replace(i,"</div>")}c=document.createElement("div"),c.innerHTML=a,e=c.childNodes.length;for(d=0;d<e;d+=1)f[d]=c.childNodes[d];return f},getEl:function(a){var b;if(!a)throw new Error("No container element specified");if(a.tagName)return a;if(typeof a=="string"){b=document.getElementById(a);if(b.tagName)return b}throw new Error("Could not find container element")},splitKeypath:function(a){var c,d=[],e;c=a.split(".");for(e=0;e<c.length;e+=1)d=d.concat(b.parseArrayNotation(c[e]));return d},parseArrayNotation:function(a){var b,c,d,e,f;b=a.indexOf("[");if(b===-1)return a;f=[a.substr(0,b)],c=a.substring(b),d=/\[([0-9]+)\]/;while(c.length){e=d.exec(c);if(!e)return f;f[f.length]=+e[1],c=c.substring(e[0].length)}return f},nodeListToArray:function(a){var b,c=a.length,d=[];for(b=0;b<c;b+=1)d[b]=a[b];return d},attributeListToArray:function(a){var b,c=a.length,d=[];for(b=0;b<c;b+=1)d[b]={name:a[b].name,value:a[b].value};return d},escape:function(a){var b=/[\[\]\(\)\{\}\^\$\*\+\?\.\|]/g;return a.replace(b,"\\$&")},compileMustachePattern:function(){var b=this.escape(a.delimiters[0]),c=this.escape(a.delimiters[1]),d=this.escape(a.tripleDelimiters[0]),e=this.escape(a.tripleDelimiters[1]);a.patterns.mustache=new RegExp("(?:("+d+")|("+b+"))"+"(?:(?:"+"(=)\\s*([^\\s]+)\\s+([^\\s]+)\\s*(=)"+"(?:("+e+")|("+c+"))"+")|(?:"+"(#|\\^|\\/)?"+"(\\>)?"+"(&)?"+"(!)?"+"\\s*"+"([\\s\\S]+?)"+"\\s*"+"(?:("+e+")|("+c+"))"+"))","g")},preProcess:function(c){var d="",e=c,f,g,h,i,j,k,l,m,n;l=a.delimiters.concat(),m=a.tripleDelimiters.concat(),i=/(?:\r)?\n\s*$/,j=/^\s*(?:\r)?\n/,k=/section|comment|delimiterChange/;while(e.length){f=b.findMustache(e);if(!f){d+=e;break}k.test(f.type)?(g=e.substr(0,f.start),h=e.substring(f.end),i.test(g)&&j.test(h)&&(g=g.replace(/(?:\r)?\n\s*$/,"")),d+=g,f.type!=="comment"&&(d+=f[0]),e=h):(d+=e.substr(0,f.end),e=e.substring(f.end))}if(a.delimiters[0]!==l[0]||a.delimiters[1]!==l[1])a.delimiters=l,n=!0;if(a.tripleDelimiters[0]!==m[0]||a.tripleDelimiters[1]!==m[1])a.tripleDelimiters=m,n=!0;return n&&b.compileMustachePattern(),d},findMustache:function(c,d){var e,f,g,h,i,j,k,l,m;g=a.patterns.mustache,h=" | ",k=a.patterns.formatter,e=b.findMatch(c,g,d);if(e){if(e[3]&&e[6])e.type="delimiterChange",e[1]&&e[7]?a.tripleDelimiters=[e[4],e[5]]:a.delimiters=[e[4],e[5]],b.compileMustachePattern();else{e.formula=e[13],f=e.formula.split(h),e.partialKeypath=f.shift(),e.formatters=[];for(i=0;i<f.length;i+=1){j=k.exec(f[i]);if(j){l={name:j[1]};if(j[2])try{l.args=JSON.parse(j[2])}catch(n){throw new Error("Illegal arguments for formatter '"+l.name+"': "+j[2]+" (JSON.parse() failed)")}e.formatters.push(l)}}if(e[9])e.type="section",e.inverted=e[9]==="^"?!0:!1,e.closing=e[9]==="/"?!0:!1;else if(e[10])e.type="partial";else if(e[1]){if(!e[14])return!1;e.type="triple"}else e[12]?e.type="comment":e.type="interpolator"}return e.isMustache=!0,e}return!1},findMatch:function(a,b,c){var d;if(b.global)b.lastIndex=c||0;else throw new Error("You must pass findMatch() a regex with the global flag set");d=b.exec(a);if(d)return d.end=b.lastIndex,d.start=d.end-d[0].length,d},getStubsFromNodes:function(a){var c,d,e,f=[],g;d=a.length;for(c=0;c<d;c+=1)e=a[c],e.nodeType===1?f[f.length]={type:"element",original:e}:e.nodeType===3&&(g=b.expandText(e.data),g&&(f=f.concat(g)));return f},expandText:function(a){var c=[],d,e,f,g,h,i,j;d=b.findMustache(a);while(d.type==="delimiterChange")d.start>0&&(c[c.length]={type:"text",text:a.substr(0,d.start)}),a=a.substring(d.end),d=b.findMustache(a);return d?(i=!0,f=/\s*\n\s*$/,d.start>0&&(g=a.substr(0,d.start),c[c.length]={type:"text",text:g}),c[c.length]={type:"mustache",mustache:d},d.end<a.length&&(j=b.expandText(a.substring(d.end)),j&&(c=c.concat(j))),c):a?c.concat({type:"text",text:a}):c.length?c:!1},isEqual:function(a,b){var c=function(a,b,d){var e,f,g,h,i,j;e=Object.prototype.toString;if(a===b)return a!==0||1/a==1/b;if(a==null||b==null)return a===b;f=e.call(a);if(f!=e.call(b))return!1;switch(f){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if(typeof a!="object"||typeof b!="object")return!1;g=d.length;while(g--)if(d[g]==a)return!0;d.push(a),h=0,i=!0;if(f=="[object Array]"){h=a.length,i=h==b.length;if(i)while(h--)if(!(i=h in a==h in b&&c(a[h],b[h],d)))break}else{if("constructor"in a!="constructor"in b||a.constructor!=b.constructor)return!1;for(j in a)if(a.hasOwnProperty(j)){h++;if(!(i=b.hasOwnProperty(j)&&c(a[j],b[j],d)))break}if(i){for(j in b)if(b.hasOwnProperty(j)&&!(h--))break;i=!h}}return d.pop(),i};return c(a,b,[])},isArray:function(a){return Object.prototype.toString.call(a)==="[object Array]"},isObject:function(a){return Object.prototype.toString.call(a)==="[object Object]"&&typeof a!="function"},compileStubs:function(a,c,d,e){var f,g,h;f=[],h=function(g){var h,i,j,k,l,m,n,o,p,q,r;h=/^\s*\n\r?\s*$/,m=a[g];switch(m.type){case"text":if(!e)if(h.test(m.text)||m.text==="")return g+1;return f[f.length]=m,g+1;case"element":return f[f.length]=b.processElementStub(m,c,d),g+1;case"mustache":r=m.mustache.partialKeypath;switch(m.mustache.type){case"section":g+=1,n=g,p=1;while(g<a.length&&!o)q=a[g],q.type==="mustache"&&q.mustache.type==="section"&&q.mustache.partialKeypath===r&&(q.mustache.closing?(p-=1,p||(o=g)):p+=1),g+=1;if(!o)throw new Error('Illegal section "'+r+'"');return f[f.length]={type:"section",partialKeypath:r,formatters:m.mustache.formatters,inverted:m.mustache.inverted,children:b.compileStubs(a.slice(n,o),c+1,d,e),priority:c},g;case"triple":return f[f.length]={type:"triple",partialKeypath:m.mustache.partialKeypath,formatters:m.mustache.formatters,priority:c},g+1;case"interpolator":return f[f.length]={type:"interpolator",partialKeypath:m.mustache.partialKeypath,formatters:m.mustache.formatters,priority:c},g+1;default:throw console&&console.error&&console.error("Bad mustache: ",m.mustache),new Error("Error compiling template: Illegal mustache ("+m.mustache[0]+")")}break;default:throw new Error("Error compiling template. Something *very weird* has happened")}},g=0;while(g<a.length)g=h(g);return f},processElementStub:function(a,c,d){var e,f,g,h,i,j;j=a.original,e={type:"element",tag:j.getAttribute("data-anglebars-elementname")||j.localName,priority:c},d&&(e.namespace=d),f=[],g=j.attributes.length;for(i=0;i<g;i+=1){h=j.attributes[i];if(f.name==="data-anglebars-elementname")continue;h.name==="xmlns"?e.namespace=h.value:f[f.length]=b.processAttribute(h.name,h.value,c+1)}return e.attributes=f,e.children=b.compileStubs(b.getStubsFromNodes(j.childNodes),c+1,e.namespace),e},processAttribute:function(a,c,d){var e,f;return f=b.expandText(c),e={name:a.replace("data-anglebars-","")},!b.findMustache(c)||!f?(e.value=c,e):(e.isDynamic=!0,e.priority=d,e.components=b.compileStubs(f,d,null),e)}}}(Anglebars),Anglebars.compile=function(a,b){var c,d,e=[],f,g,h=Anglebars.utils;return b=b||{},Anglebars.delimiters=b.delimiters||["{{","}}"],Anglebars.tripleDelimiters=b.tripleDelimiters||["{{{","}}}"],Anglebars.utils.compileMustachePattern(),a=h.preProcess(a),c=h.getNodeArrayFromHtml(a,b.replaceSrcAttributes===undefined?!0:b.replaceSrcAttributes),d=h.getStubsFromNodes(c),e=h.compileStubs(d,0,b.namespace,b.preserveWhitespace),e},Anglebars.patterns={formatter:/([a-zA-Z_$][a-zA-Z_$0-9]*)(\[[^\]]*\])?/,preprocessorTypes:/section|comment|delimiterChange/,standalonePre:/(?:\r)?\n[ \t]*$/,standalonePost:/^[ \t]*(\r)?\n/,standalonePreStrip:/[ \t]+$/},Anglebars.views={create:function(a){var b=a.model.type;return b=b.charAt(0).toUpperCase()+b.slice(1),new Anglebars.views[b](a)}},Anglebars.substrings={create:function(a){var b=a.model.type;return b=b.charAt(0).toUpperCase()+b.slice(1),new Anglebars.substrings[b](a)}},Anglebars.ViewModel=function(a){this.data=a||{},this.pendingResolution=[],this.observers={}},Anglebars.ViewModel.prototype={set:function(a,b){var c,d,e,f,g,h,i;if(typeof a=="object"){for(c in a)a.hasOwnProperty(c)&&this.set(c,a[c]);return}i=this.get(a),d=Anglebars.utils.splitKeypath(a),f=this.data;while(d.length>1)e=d.shift(),f=f[e]||{};e=d[0],f[e]=b,Anglebars.utils.isEqual(i,b)||this.publish(a,b),g=this.pendingResolution.length;while(g--)h=this.pendingResolution.splice(g,1)[0],this.getKeypath(h.item,h.item.model.partialKeypath,h.item.contextStack,h.callback)},get:function(a){var b,c;if(!a)return"";b=a.split("."),c=this.data;while(b.length){c&&(c=c[b.shift()]);if(c===undefined)return""}return c},update:function(a){var b=this.get(a);this.publish(a,b)},getKeypath:function(a,b,c,d){var e,f,g,h,i,j;c=c?c.concat():[],i=c.concat(),b==="."&&(a.keypath=c[c.length-1],d.call(a,a.keypath));while(c){g=c.length?c[c.length-1]:null,e=g?g.split(".").concat(b.split(".")):b.split("."),f=e.concat(),h=this.data;while(e.length){h&&(h=h[e.shift()]);if(h===undefined)break}if(h!==undefined){j=f.join("."),a.keypath=j,d.call(a,j);break}c.length?c.pop():c=!1}h===undefined&&this.registerUnresolvedAddress(a,d)},registerUnresolvedAddress:function(a,b){this.pendingResolution[this.pendingResolution.length]={item:a,callback:b}},cancelAddressResolution:function(a){if(this.pendingResolution.filter)this.pendingResolution=this.pendingResolution.filter(function(b){return b.item!==a});else{var b,c=[];for(b=0;b<this.pendingResolution.length;b+=1)this.pendingResolution[b].item!==a&&(c[c.length]=this.pendingResolution[b]);this.pendingResolution=c}},publish:function(a,b){var c=this,d=this.observers[a]||[],e,f,g,h;for(e=0;e<d.length;e+=1){g=d[e];if(g)for(f=0;f<g.length;f+=1)h=g[f],a!==h.originalAddress&&(b=c.get(h.originalAddress)),h.callback(b)}},observe:function(a,b,c){var d=this,e=a,f=[],g;if(!a)return undefined;g=function(a){var g,h;g=d.observers[a]=d.observers[a]||[],g=g[b]=g[b]||[],h={callback:c,originalAddress:e},g[g.length]=h,f[f.length]={keypath:a,priority:b,observer:h}};while(a.lastIndexOf(".")!==-1)g(a),a=a.substr(0,a.lastIndexOf("."));return g(a),f},unobserve:function(a){var b,c,d;b=this.observers[a.keypath];if(!b)return;c=b[a.priority];if(!c)return;d=c.indexOf(a.observer);if(d===-1)return;c.splice(d,1),c.length===0&&delete b[a.priority],b.length===0&&delete this.observers[a.keypath]},unobserveAll:function(a){while(a.length)this.unobserve(a.shift())}};