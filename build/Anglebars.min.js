/*! Anglebars - v0.0.1 - 2012-10-19
* http://rich-harris.github.com/Anglebars/
* Copyright (c) 2012 Rich Harris; Licensed WTFPL */
var Anglebars=function(a){a=a||{},a.el!==undefined&&(this.el=Anglebars.utils.getEl(a.el)),a.compiled!==undefined&&(this.compiled=a.compiled),a.template!==undefined&&(this.template=a.template),this.data=a.data instanceof Anglebars.DataModel?a.data:new Anglebars.DataModel(a.data),a.formatters!==undefined&&(this.formatters=a.formatters),this.preserveWhitespace=a.preserveWhitespace===undefined?!1:a.preserveWhitespace,this.replaceSrcAttributes=a.replaceSrcAttributes===undefined?!0:a.replaceSrcAttributes,!this.compiled&&this.template&&(this.compiled=Anglebars.compile(this.template,{preserveWhitespace:this.preserveWhitespace,replaceSrcAttributes:this.replaceSrcAttributes})),this.compiled&&this.el&&(this.el.innerHTML="",this.render())};Anglebars.prototype={render:function(a){a=a?Anglebars.utils.getEl(a):this.el;if(!a)throw new Error("You must specify a DOM element to render to");this.rendered=new Anglebars.views.Fragment(this.compiled,this,a)},set:function(){return this.data.set.apply(this.data,arguments),this},get:function(){return this.data.get.apply(this.data,arguments)},update:function(){return this.data.update.apply(this.data,arguments),this},_format:function(a,b){var c,d,e,f,g;d=b.length;for(c=0;c<d;c+=1)e=b[c],f=e.name,g=e.args||[],this.formatters[f]&&(a=this.formatters[f].apply(this,[a].concat(g)));return a}},Anglebars.views={},Anglebars.substrings={},Anglebars.utils={},Anglebars.compile=function(a,b){var c,d,e=[],f=Anglebars.utils;return a=f.stripComments(a),c=f.getNodeArrayFromHtml(a,b.replaceSrcAttributes===undefined?!0:b.replaceSrcAttributes),d=f.getStubsFromNodes(c),e=f.compileStubs(d,0,null,b.preserveWhitespace),e},Anglebars.DataModel=function(a){this.data=a||{},this.pendingResolution=[],this.observers={}},Anglebars.DataModel.prototype={set:function(a,b){var c,d,e,f,g,h,i;if(typeof a=="object"){for(c in a)a.hasOwnProperty(c)&&this.set(c,a[c]);return}i=this.get(a),d=Anglebars.utils.splitKeypath(a),f=this.data;while(d.length>1)e=d.shift(),f=f[e]||{};e=d[0],f[e]=b,Anglebars.utils.isEqual(i,b)||this.publish(a,b),g=this.pendingResolution.length;while(g--)h=this.pendingResolution.splice(g,1)[0],this.getKeypath(h.item,h.item.model.partialKeypath,h.item.contextStack,h.callback)},get:function(a){var b,c;if(!a)return"";b=a.split("."),c=this.data;while(b.length){c=c[b.shift()];if(c===undefined)return""}return c},update:function(a){var b=this.get(a);this.publish(a,b)},getKeypath:function(a,b,c,d){var e,f,g,h,i,j;c=c?c.concat():[],i=c.concat();while(c){g=c.length?c[c.length-1]:null,e=g?g.split(".").concat(b.split(".")):b.split("."),f=e.concat(),h=this.data;while(e.length){h=h[e.shift()];if(h===undefined)break}if(h!==undefined){j=f.join("."),a.keypath=j,d.call(a,j);break}c.length?c.pop():c=!1}h===undefined&&this.registerUnresolvedAddress(a,d)},registerUnresolvedAddress:function(a,b){this.pendingResolution[this.pendingResolution.length]={item:a,callback:b}},cancelAddressResolution:function(a){if(this.pendingResolution.filter)this.pendingResolution=this.pendingResolution.filter(function(b){return b.item!==a});else{var b,c=[];for(b=0;b<this.pendingResolution.length;b+=1)this.pendingResolution[b].item!==a&&(c[c.length]=this.pendingResolution[b]);this.pendingResolution=c}},publish:function(a,b){var c=this,d=this.observers[a]||[],e,f,g,h;for(e=0;e<d.length;e+=1){g=d[e];if(g)for(f=0;f<g.length;f+=1)h=g[f],a!==h.originalAddress&&(b=c.get(h.originalAddress)),h.callback(b)}},observe:function(a,b,c){var d=this,e=a,f=[],g;if(!a)return undefined;g=function(a){var g,h;g=d.observers[a]=d.observers[a]||[],g=g[b]=g[b]||[],h={callback:c,originalAddress:e},g[g.length]=h,f[f.length]={keypath:a,level:b,observer:h}};while(a.lastIndexOf(".")!==-1)g(a),a=a.substr(0,a.lastIndexOf("."));return g(a),f},unobserve:function(a){var b,c,d;b=this.observers[a.keypath];if(!b)return;c=b[a.level];if(!c)return;d=c.indexOf(a.observer);if(d===-1)return;c.splice(d,1),c.length===0&&delete b[a.level],b.length===0&&delete this.observers[a.keypath]},unobserveAll:function(a){while(a.length)this.unobserve(a.shift())}},Anglebars.view=function(a){var b;return b=function(a,b,c,d,e){this.model=a,this.formatters=a.formatters,this.anglebars=b,this.data=b.data,this.parentNode=c,this.contextStack=d||[],this.anchor=e,this.initialize(),this.data.getKeypath(this,a.partialKeypath,d,function(a){var b,c,d=this;b=this.data.get(this.keypath),c=this.anglebars._format(b,this.formatters),this.update(c),this.observerRefs=this.data.observe(this.keypath,this.model.level,function(a){var b=d.anglebars._format(a,d.model.formatters);d.update(b),d.bubble&&d.bubble()})})},b.prototype=a,b},Anglebars.views.Attribute=function(a,b,c,d,e){var f,g,h;if(!a.isDynamic){c.setAttribute(a.name,a.value);return}this.parentNode=c,this.name=a.name,this.substrings=[],g=a.components.length;for(f=0;f<g;f+=1)h=a.components[f],this.substrings[f]=Anglebars.substrings.create(h,b,this,d);this.update()},Anglebars.views.Attribute.prototype={teardown:function(){var a,b,c;a=this.substrings.length;for(b=0;b<a;b+=1)c=this.substrings[b],c.teardown&&c.teardown()},bubble:function(){this.update()},update:function(){this.value=this.toString(),this.parentNode.setAttribute(this.name,this.value)},toString:function(){var a="",b,c,d;c=this.substrings.length;for(b=0;b<c;b+=1)d=this.substrings[b],a+=d.toString();return a}},Anglebars.views.create=function(a,b,c,d,e){var f=Anglebars.views;switch(a.type){case"text":return new f.Text(a,c,e);case"interpolator":return new f.Interpolator(a,b,c,d,e);case"triple":return new f.Triple(a,b,c,d,e);case"element":return new f.Element(a,b,c,d,e);case"section":return new f.Section(a,b,c,d,e)}},Anglebars.views.Element=function(a,b,c,d,e){var f=b.data,g,h,i,j,k;this.model=a,this.data=f,a.namespace?this.node=document.createElementNS(a.namespace,a.tag):this.node=document.createElement(a.tag),this.attributes=[],h=a.attributes.length;for(g=0;g<h;g+=1)j=a.attributes[g],this.attributes[g]=new Anglebars.views.Attribute(j,b,this.node,d);if(a.children){this.children=[],i=a.children.length;for(g=0;g<i;g+=1)k=a.children[g],this.children[g]=Anglebars.views.create(k,b,this.node,d)}c.insertBefore(this.node,e||null)},Anglebars.views.Element.prototype={teardown:function(){var a,b;a=this.attributes.length;for(b=0;b<a;b+=1)this.attributes[b].teardown();Anglebars.utils.remove(this.node)}},Anglebars.views.Fragment=function(a,b,c,d,e){var f,g;this.items=[],f=a.length;for(g=0;g<f;g+=1)this.items[this.items.length]=Anglebars.views.create(a[g],b,c,d,e)},Anglebars.views.Fragment.prototype={teardown:function(){var a,b;b=this.items.length;for(a=0;a<b;a+=1)this.items[a].teardown();delete this.items}},Anglebars.views.Interpolator=Anglebars.view({initialize:function(){this.node=document.createTextNode(""),this.parentNode.insertBefore(this.node,this.anchor||null)},teardown:function(){this.observerRefs?this.data.unobserveAll(this.observerRefs):this.data.cancelAddressResolution(this),utils.remove(this.node)},update:function(a){this.node.data=a}}),Anglebars.views.Section=Anglebars.view({initialize:function(){this.views=[],this.sectionAnchor=Anglebars.utils.createAnchor(),this.parentNode.insertBefore(this.sectionAnchor,this.anchor)},teardown:function(){this.unrender(),this.subscriptionRefs?this.data.unsubscribeAll(this.subscriptionRefs):this.data.cancelAddressResolution(this),Anglebars.utils.remove(this.anchor)},unrender:function(){while(this.views.length)this.views.shift().teardown()},update:function(a){var b,c,d=Anglebars.views;Anglebars.utils.isArray(a)&&a.length===0&&(b=!0);if(this.model.inverted){if(a&&!b){if(this.rendered){this.unrender(),this.rendered=!1;return}}else if(!this.rendered){this.views[0]=new d.Fragment(this.model.children,this.anglebars,this.parentNode,this.contextStack,this.sectionAnchor),this.rendered=!0;return}return}switch(typeof a){case"object":this.rendered&&(this.unrender(),this.rendered=!1);if(Anglebars.utils.isArray(a)){if(b)return;for(c=0;c<a.length;c+=1)this.views[c]=new d.Fragment(this.model.children,this.anglebars,this.parentNode,this.contextStack.concat(this.keypath+"."+c),this.sectionAnchor)}else this.views[0]=new d.Fragment(this.model.children,this.anglebars,this.parentNode,this.contextStack.concat(this.keypath),this.sectionAnchor);this.rendered=!0;break;default:a&&!b?this.rendered||(this.views[0]=new d.Fragment(this.model.children,this.anglebars,this.parentNode,this.contextStack,this.sectionAnchor),this.rendered=!0):this.rendered&&(this.unrender(),this.rendered=!1)}}}),Anglebars.views.Text=function(a,b,c){this.node=document.createTextNode(a.text),b.insertBefore(this.node,c||null)},Anglebars.views.Text.prototype={teardown:function(){Anglebars.utils.remove(this.node)}},Anglebars.views.Triple=Anglebars.view({initialize:function(){this.nodes=[],this.tripleAnchor=Anglebars.utils.createAnchor(),this.parentNode.insertBefore(this.tripleAnchor,this.anchor||null)},teardown:function(){var a,b;b=this.nodes.length;for(a=0;a<b;a+=1)Anglebars.utils.remove(this.nodes[a]);this.subscriptionRefs?this.data.unsubscribeAll(this.subscriptionRefs):this.data.cancelAddressResolution(this),Anglebars.utils.remove(this.anchor)},update:function(a){var b,c,d=Anglebars.utils;if(d.isEqual(this.value,a))return;b=this.nodes.length;for(c=0;c<b;c+=1)d.remove(this.nodes[c]);this.nodes=d.getNodeArrayFromHtml(a,!1),b=this.nodes.length;for(c=0;c<b;c+=1)this.parentNode.insertBefore(this.nodes[c],this.tripleAnchor)}}),Anglebars.substring=function(a){var b;return b=function(a,b,c,d){this.model=a,this.formatters=a.formatters,this.anglebars=b,this.data=b.data,this.parent=c,this.contextStack=d||[],this.initialize(),this.data.getKeypath(this,a.partialKeypath,d,function(a){var b,c,d=this;b=this.data.get(this.keypath),this.update(this.anglebars._format(b,this.formatters)),this.observerRefs=this.data.observe(this.keypath,this.model.level,function(a){d.update(d.anglebars._format(a,d.model.formatters))})})},b.prototype=a,b},Anglebars.substrings.create=function(a,b,c,d){var e=Anglebars.substrings;switch(a.type){case"text":return new e.Text(a,c);case"interpolator":case"triple":return new e.Interpolator(a,b,c,d);case"section":return new e.Section(a,b,c,d)}},Anglebars.substrings.Fragment=function(a,b,c,d){var e,f,g;this.substrings=[],e=a.items.length;for(g=0;g<e;g+=1)f=substrings.create(a.items[g],b,this,d),this.substrings[g]=f;this.value=this.substrings.join("")},Anglebars.substrings.Fragment.prototype={bubble:function(){this.value=this.substrings.join(""),this.parent.bubble()},teardown:function(){var a,b;a=this.substrings.length;for(b=0;b<a;b+=1)this.substrings[b].teardown()},toString:function(){return this.value}},Anglebars.substrings.Interpolator=Anglebars.substring({initialize:function(){},update:function(a){this.value=a,this.parent.bubble()},bubble:function(){this.parent.bubble()},teardown:function(){this.subscriptionRefs?this.data.unsubscribeAll(this.subscriptionRefs):this.data.cancelAddressResolution(this)},toString:function(){return this.value}}),Anglebars.substrings.Triple=Anglebars.substrings.Interpolator,Anglebars.substrings.Section=Anglebars.substring({initialize:function(){this.substrings=[]},bubble:function(){this.value=this.substrings.join(""),this.parent.bubble()},teardown:function(){},update:function(a){var b,c;_.isArray(a)&&a.length===0&&(b=!0);if(this.model.inverted){if(a&&!b){if(this.rendered){this.substrings=[],this.rendered=!1;return}}else if(!this.rendered){this.substrings[0]=[];for(c=0;c<this.model.children.length;c+=1)this.substrings[0][c]=Anglebars.substrings.create(this.model.children[c],this.anglebars,this,this.contextStack);this.rendered=!0;return}return}if(typeof a=="object"){this.rendered&&(this.substrings=[],this.rendered=!1);if(Anglebars.utils.isArray(a)&&!b)for(c=0;c<a.length;c+=1){this.substrings[c]=[];for(j=0;j<this.model.children.length;j+=1)this.substrings[c][j]=Anglebars.substrings.create(this.model.children[j],this.anglebars,this,this.contextStack.concat(this.keypath+"."+c))}else{this.substrings[0]=[];for(c=0;c<this.model.children.length;c+=1)this.substrings[0][c]=Anglebars.substrings.create(this.model.children[c],this.anglebars,this,this.contextStack.concat(this.keypath))}this.rendered=!0}else if(a&&!b){if(!this.rendered){this.substrings[0]=[];for(c=0;c<this.model.children.length;c+=1)this.substrings[0][c]=Anglebars.substrings.create(this.model.children[c],this.anglebars,this,this.contextStack);this.rendered=!0}}else this.rendered&&(this.substrings=[],this.rendered=!1);this.value=this.substrings.join(""),this.parent.bubble()},toString:function(){return this.value}}),Anglebars.substrings.Text=function(a){this.text=a.text},Anglebars.substrings.Text.prototype={toString:function(){return this.text}},function(a,b){"use strict";var c=a.utils,d=/^\s+$/;c.remove=function(a){a.parentNode&&a.parentNode.removeChild(a)},c.trim=function(a){var b=a.replace(/^\s+/,"").replace(/\s+$/,"");return b},c.getNodeArrayFromHtml=function(a,c){var d,e,f,g,h,i=[],j,k;if(c){j=["src","poster"];for(g=0;g<j.length;g+=1)k=new RegExp("(<[^>]+\\s)("+j[g]+"=)","g"),a=a.replace(k,"$1data-anglebars-"+j[g]+"=")}b.implementation&&b.implementation.createDocument?(e=b.implementation.createDocument("http://www.w3.org/1999/xhtml","html",null),f=b.createElementNS("http://www.w3.org/1999/xhtml","body")):f=b.createElement("div"),f.innerHTML=a,h=f.childNodes.length;for(g=0;g<h;g+=1)i[g]=f.childNodes[g];return i},c.getEl=function(a){var c;if(!a)throw new Error("No container element specified");if(a instanceof HTMLElement)return a;if(typeof a=="string"){c=b.getElementById(a);if(c instanceof HTMLElement)return c}throw new Error("Could not find container element")},c.splitKeypath=function(a){var b,d=[],e,f,g,h,i,j;b=a.split(".");for(g=0;g<b.length;g+=1)d=d.concat(c.parseArrayNotation(b[g]));return d},c.parseArrayNotation=function(a){var b,c,d,e,f;b=a.indexOf("[");if(b===-1)return a;f=[a.substr(0,b)],c=a.substring(b),d=/\[([0-9]+)\]/;while(c.length){e=d.exec(c);if(!e)return f;f[f.length]=+e[1],c=c.substring(e[0].length)}return f},c.stripComments=function(a){var b=/\{\{!\s*[\s\S]+?\s*\}\}/g,c=/(^|\n|\r\n)\s*\{\{!\s*[\s\S]+?\s*\}\}\s*($|\n|\r\n)/g,d;return d=a.replace(c,function(a,b,c,d,e){return b}),d=d.replace(b,""),d},c.createAnchor=function(){var a=b.createElement("a");return a.setAttribute("class","anglebars-anchor"),a},c.nodeListToArray=function(a){var b,c=a.length,d=[];for(b=0;b<c;b+=1)d[b]=a[b];return d},c.attributeListToArray=function(a){var b,c=a.length,d=[];for(b=0;b<c;b+=1)d[b]={name:a[b].name,value:a[b].value};return d},c.findMustache=function(a,b){var d,e,f,g,h,i,j,k,l,m,n,o;f=/(\{)?\{\{(#|\^|\/)?(\>)?(&)?\s*([\s\S]+?)\s*\}\}(\})?/g,g=" | ",j=/([a-zA-Z_$][a-zA-Z_$0-9]*)(\[[^\]]*\])?/,d=c.findMatch(a,f,b);if(d){d.formula=d[5],e=d.formula.split(g),d.partialKeypath=e.shift(),d.formatters=[];for(h=0;h<e.length;h+=1){i=j.exec(e[h]);if(i){m={name:i[1]};if(i[2])try{m.args=JSON.parse(i[2])}catch(p){throw new Error("Illegal arguments for formatter '"+m.name+"': "+i[2]+" (JSON.parse() failed)")}d.formatters.push(m)}}if(d[2])d.type="section",d.inverted=d[2]==="^"?!0:!1,d.closing=d[2]==="/"?!0:!1;else if(d[3])d.type="partial";else if(d[1]){if(!d[6])return!1;d.type="triple"}else d.type="interpolator";return d.isMustache=!0,d}return!1},c.findMatch=function(a,b,c){var d;if(b.global)b.lastIndex=c||0;else throw new Error("You must pass findMatch() a regex with the global flag set");d=b.exec(a);if(d)return d.end=b.lastIndex,d.start=d.end-d[0].length,d},c.getStubsFromNodes=function(a){var b,d,e,f=[];d=a.length;for(b=0;b<d;b+=1)e=a[b],e.nodeType===1?f[f.length]={type:"element",original:e}:e.nodeType===3&&(f=f.concat(c.expandText(e.data)));return f},c.expandText=function(a){var b,d;return d=c.findMustache(a),d?(b=[],d.start>0&&(b[b.length]={type:"text",text:a.substr(0,d.start)}),b[b.length]={type:"mustache",mustache:d},d.end<a.length&&(b=b.concat(c.expandText(a.substring(d.end)))),b):{type:"text",text:a}},c.setText=function(a,b){a.textContent!==undefined?a.textContent=b:a.data=b},c.isEqual=function(a,b){var c=function(a,b,d){var e=Object.prototype.toString;if(a===b)return a!==0||1/a==1/b;if(a==null||b==null)return a===b;var f=e.call(a);if(f!=e.call(b))return!1;switch(f){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if(typeof a!="object"||typeof b!="object")return!1;var g=d.length;while(g--)if(d[g]==a)return!0;d.push(a);var h=0,i=!0;if(f=="[object Array]"){h=a.length,i=h==b.length;if(i)while(h--)if(!(i=h in a==h in b&&c(a[h],b[h],d)))break}else{if("constructor"in a!="constructor"in b||a.constructor!=b.constructor)return!1;for(var j in a)if(a.hasOwnProperty(j)){h++;if(!(i=b.hasOwnProperty(j)&&c(a[j],b[j],d)))break}if(i){for(j in b)if(b.hasOwnProperty(j)&&!(h--))break;i=!h}}return d.pop(),i};return c(a,b,[])},c.isArray=function(a){return Object.prototype.toString.call(a)==="[object Array]"},c.compileStubs=function(a,b,e,f){var g,h,i;g=[],i=function(h){var i,j,k,l,m,n,o,p,q,r;m=a[h];switch(m.type){case"text":if(!f)if(d.test(m.text)||m.text==="")return h+1;return g[g.length]=m,h+1;case"element":return g[g.length]=c.processElementStub(m,b,e),h+1;case"mustache":r=m.mustache.partialKeypath;switch(m.mustache.type){case"section":h+=1,n=h,p=1;while(h<a.length&&!o)q=a[h],q.type==="mustache"&&q.mustache.type==="section"&&q.mustache.partialKeypath===r&&(q.mustache.closing?(p-=1,p||(o=h)):p+=1),h+=1;if(!o)throw new Error('Illegal section "'+r+'"');return g[g.length]={type:"section",partialKeypath:r,formatters:m.mustache.formatters,inverted:m.mustache.inverted,children:c.compileStubs(a.slice(n,o),b+1,e,f),level:b},h;case"triple":return g[g.length]={type:"triple",partialKeypath:m.mustache.partialKeypath,formatters:m.mustache.formatters,level:b},h+1;case"interpolator":return g[g.length]={type:"interpolator",partialKeypath:m.mustache.partialKeypath,formatters:m.mustache.formatters,level:b},h+1;default:throw new Error("Error compiling template")}break;default:throw new Error("Error compiling template")}},h=0;while(h<a.length)h=i(h);return g},c.processElementStub=function(a,b,d){var e,f,g,h,i,j;j=a.original,e={type:"element",tag:j.tagName,level:b},d&&(e.namespace=d),f=[],g=j.attributes.length;for(i=0;i<g;i+=1)h=j.attributes[i],h.name==="xmlns"?e.namespace=h.value:f[f.length]=c.processAttribute(h.name,h.value,b+1);return e.attributes=f,e.children=c.compileStubs(c.getStubsFromNodes(j.childNodes),b+1,e.namespace),e},c.processAttribute=function(a,b,d){var e,f;return f=c.expandText(b),e={name:a.replace("data-anglebars-","")},c.findMustache(b)?(e.isDynamic=!0,e.level=d,e.components=c.compileStubs(f,d,null),e):(e.value=b,e)}}(Anglebars,document);