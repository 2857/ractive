/*! Anglebars - v0.1.0 - 2012-11-14
* http://rich-harris.github.com/Anglebars/
* Copyright (c) 2012 Rich Harris; Licensed WTFPL */

/*jslint eqeq: true, plusplus: true */
/*global document, HTMLElement */

'use strict';


"use strict";var Anglebars=function(a){a=a||{},a.el!==undefined&&(this.el=Anglebars.utils.getEl(a.el)),a.compiled!==undefined&&(this.compiled=a.compiled),a.template!==undefined&&(this.template=a.template),this.viewmodel=a.data instanceof Anglebars.ViewModel?a.data:new Anglebars.ViewModel(a.data),a.formatters!==undefined&&(this.formatters=a.formatters),this.preserveWhitespace=a.preserveWhitespace===undefined?!1:a.preserveWhitespace,this.replaceSrcAttributes=a.replaceSrcAttributes===undefined?!0:a.replaceSrcAttributes,this.namespace=a.namespace?a.namespace:this.el&&this.el.namespaceURI!=="http://www.w3.org/1999/xhtml"?this.el.namespaceURI:null,!this.compiled&&this.template&&(this.compiled=Anglebars.compile(this.template,{preserveWhitespace:this.preserveWhitespace,replaceSrcAttributes:this.replaceSrcAttributes,namespace:this.namespace})),this.compiled&&this.el&&(this.el.innerHTML="",this.render())};Anglebars.prototype={render:function(a){a=a?Anglebars.utils.getEl(a):this.el;if(!a)throw new Error("You must specify a DOM element to render to");this.rendered=new Anglebars.views.Fragment(this.compiled,this,a)},teardown:function(){this.rendered.teardown(),this.el.innerHTML=""},set:function(){return this.viewmodel.set.apply(this.viewmodel,arguments),this},get:function(){return this.viewmodel.get.apply(this.viewmodel,arguments)},update:function(){return this.viewmodel.update.apply(this.viewmodel,arguments),this},_format:function(a,b){var c,d,e,f,g;d=b.length;for(c=0;c<d;c+=1)e=b[c],f=e.name,g=e.args||[],this.formatters[f]&&(a=this.formatters[f].apply(this,[a].concat(g)));return a}},Anglebars.views={},Anglebars.substrings={},Anglebars.utils={},Anglebars.compile=function(a,b){var c,d,e=[],f,g,h=Anglebars.utils;return b=b||{},Anglebars.delimiters=b.delimiters||["{{","}}"],Anglebars.tripleDelimiters=b.tripleDelimiters||["{{{","}}}"],Anglebars.utils.compileMustachePattern(),a=h.stripComments(a),c=h.getNodeArrayFromHtml(a,b.replaceSrcAttributes===undefined?!0:b.replaceSrcAttributes),d=h.getStubsFromNodes(c),e=h.compileStubs(d,0,b.namespace,b.preserveWhitespace),e},Anglebars.patterns={formatter:/([a-zA-Z_$][a-zA-Z_$0-9]*)(\[[^\]]*\])?/},Anglebars.ViewModel=function(a){this.data=a||{},this.pendingResolution=[],this.observers={}},Anglebars.ViewModel.prototype={set:function(a,b){var c,d,e,f,g,h,i;if(typeof a=="object"){for(c in a)a.hasOwnProperty(c)&&this.set(c,a[c]);return}i=this.get(a),d=Anglebars.utils.splitKeypath(a),f=this.data;while(d.length>1)e=d.shift(),f=f[e]||{};e=d[0],f[e]=b,Anglebars.utils.isEqual(i,b)||this.publish(a,b),g=this.pendingResolution.length;while(g--)h=this.pendingResolution.splice(g,1)[0],this.getKeypath(h.item,h.item.model.partialKeypath,h.item.contextStack,h.callback)},get:function(a){var b,c;if(!a)return"";b=a.split("."),c=this.data;while(b.length){try{c=c[b.shift()]}catch(d){return""}if(c===undefined)return""}return c},update:function(a){var b=this.get(a);this.publish(a,b)},getKeypath:function(a,b,c,d){var e,f,g,h,i,j;c=c?c.concat():[],i=c.concat(),b==="."&&(a.keypath=c[c.length-1],d.call(a,a.keypath));while(c){g=c.length?c[c.length-1]:null,e=g?g.split(".").concat(b.split(".")):b.split("."),f=e.concat(),h=this.data;while(e.length){try{h=h[e.shift()]}catch(k){h=undefined;break}if(h===undefined)break}if(h!==undefined){j=f.join("."),a.keypath=j,d.call(a,j);break}c.length?c.pop():c=!1}h===undefined&&this.registerUnresolvedAddress(a,d)},registerUnresolvedAddress:function(a,b){this.pendingResolution[this.pendingResolution.length]={item:a,callback:b}},cancelAddressResolution:function(a){if(this.pendingResolution.filter)this.pendingResolution=this.pendingResolution.filter(function(b){return b.item!==a});else{var b,c=[];for(b=0;b<this.pendingResolution.length;b+=1)this.pendingResolution[b].item!==a&&(c[c.length]=this.pendingResolution[b]);this.pendingResolution=c}},publish:function(a,b){var c=this,d=this.observers[a]||[],e,f,g,h;for(e=0;e<d.length;e+=1){g=d[e];if(g)for(f=0;f<g.length;f+=1)h=g[f],a!==h.originalAddress&&(b=c.get(h.originalAddress)),h.callback(b)}},observe:function(a,b,c){var d=this,e=a,f=[],g;if(!a)return undefined;g=function(a){var g,h;g=d.observers[a]=d.observers[a]||[],g=g[b]=g[b]||[],h={callback:c,originalAddress:e},g[g.length]=h,f[f.length]={keypath:a,priority:b,observer:h}};while(a.lastIndexOf(".")!==-1)g(a),a=a.substr(0,a.lastIndexOf("."));return g(a),f},unobserve:function(a){var b,c,d;b=this.observers[a.keypath];if(!b)return;c=b[a.priority];if(!c)return;d=c.indexOf(a.observer);if(d===-1)return;c.splice(d,1),c.length===0&&delete b[a.priority],b.length===0&&delete this.observers[a.keypath]},unobserveAll:function(a){while(a.length)this.unobserve(a.shift())}},Anglebars.view=function(a){var b;return b=function(a,b,c,d,e){var f=a.formatters;this.model=a,this.anglebars=b,this.viewmodel=b.viewmodel,this.parentNode=c,this.contextStack=d||[],this.anchor=e,this.initialize(),this.viewmodel.getKeypath(this,a.partialKeypath,d,function(a){var b,c,d=this;b=this.viewmodel.get(a),this.update(this.anglebars._format(b,f)),this.observerRefs=this.viewmodel.observe(a,this.model.priority,function(a){d.update(d.anglebars._format(a,f)),d.bubble&&d.bubble()})}),!this.keypath&&this.model.inverted&&this.update(!1)},b.prototype=a,b},Anglebars.views.Attribute=function(a,b,c,d){var e,f;if(!a.isDynamic){c.setAttribute(a.name,a.value);return}this.parentNode=c,this.name=a.name,this.substrings=[],f=a.components.length;for(e=0;e<f;e+=1)this.substrings[e]=Anglebars.substrings.create(a.components[e],b,this,d);this.update()},Anglebars.views.Attribute.prototype={teardown:function(){var a,b,c;if(!this.substrings)return;a=this.substrings.length;for(b=0;b<a;b+=1)c=this.substrings[b],c.teardown&&c.teardown()},bubble:function(){this.update()},update:function(){this.value=this.toString(),this.parentNode.setAttribute(this.name,this.value)},toString:function(){var a="",b,c,d;c=this.substrings.length;for(b=0;b<c;b+=1)d=this.substrings[b],a+=d.toString();return a}},Anglebars.views.create=function(a,b,c,d,e){var f=Anglebars.views;switch(a.type){case"text":return new f.Text(a,c,e);case"interpolator":return new f.Interpolator(a,b,c,d,e);case"triple":return new f.Triple(a,b,c,d,e);case"element":return new f.Element(a,b,c,d,e);case"section":return new f.Section(a,b,c,d,e)}},Anglebars.views.Element=function(a,b,c,d,e){var f,g,h,i,j,k;this.model=a,this.viewmodel=b.viewmodel,a.namespace?this.node=document.createElementNS(a.namespace,a.tag):this.node=document.createElement(a.tag),this.attributes=[],g=a.attributes.length;for(f=0;f<g;f+=1)i=a.attributes[f],i.name!=="data-bind"||a.tag!=="INPUT"&&a.tag!=="TEXTAREA"?this.attributes[f]=new Anglebars.views.Attribute(i,b,this.node,d):k=i.value;k&&this.bind(k,b.lazy);if(a.children){this.children=[],h=a.children.length;for(f=0;f<h;f+=1)j=a.children[f],this.children[f]=Anglebars.views.create(j,b,this.node,d)}c.insertBefore(this.node,e||null)},Anglebars.views.Element.prototype={bind:function(a,b){var c=this.viewmodel,d=this.node,e;e=function(){var b=d.value;b==="0"?b=0:b!==""&&(b=+b||b),c.set(a,b)},e(),d.addEventListener("change",e),b||d.addEventListener("keyup",e)},teardown:function(){var a,b;a=this.attributes.length;for(b=0;b<a;b+=1)this.attributes[b].teardown();Anglebars.utils.remove(this.node)}},Anglebars.views.Fragment=function(a,b,c,d,e){var f,g;this.items=[],f=a.length;for(g=0;g<f;g+=1)this.items[this.items.length]=Anglebars.views.create(a[g],b,c,d,e)},Anglebars.views.Fragment.prototype={teardown:function(){var a,b;b=this.items.length;for(a=0;a<b;a+=1)this.items[a].teardown();delete this.items}},Anglebars.views.Interpolator=Anglebars.view({initialize:function(){this.node=document.createTextNode(""),this.parentNode.insertBefore(this.node,this.anchor||null)},teardown:function(){this.observerRefs?this.viewmodel.unobserveAll(this.observerRefs):this.viewmodel.cancelAddressResolution(this),Anglebars.utils.remove(this.node)},update:function(a){this.node.data=a}}),Anglebars.views.Section=Anglebars.view({initialize:function(){this.views=[],this.length=0,this.sectionAnchor=Anglebars.utils.createAnchor(),this.parentNode.insertBefore(this.sectionAnchor,this.anchor)},teardown:function(){this.unrender(),this.observerRefs?this.viewmodel.unobserveAll(this.observerRefs):this.viewmodel.cancelAddressResolution(this),Anglebars.utils.remove(this.anchor)},unrender:function(){while(this.views.length)this.views.shift().teardown()},update:function(a){var b,c,d=Anglebars.views,e;Anglebars.utils.isArray(a)&&a.length===0&&(b=!0);if(this.model.inverted){if(a&&!b){if(this.length){this.unrender(),this.length=0;return}}else if(!this.length){this.views[0]=new d.Fragment(this.model.children,this.anglebars,this.parentNode,this.contextStack,this.sectionAnchor),this.length=1;return}return}if(Anglebars.utils.isArray(a)){if(a.length<this.length){e=this.views.splice(a.length,this.length-a.length);while(e.length)e.shift().teardown()}else{for(c=0;c<this.length;c+=1)this.viewmodel.update(this.keypath+"."+c);if(a.length>this.length)for(c=this.length;c<a.length;c+=1)this.views[c]=new d.Fragment(this.model.children,this.anglebars,this.parentNode,this.contextStack.concat(this.keypath+"."+c),this.sectionAnchor)}this.length=a.length}else Anglebars.utils.isObject(a)?this.length||(this.views[0]=new d.Fragment(this.model.children,this.anglebars,this.parentNode,this.contextStack.concat(this.keypath),this.sectionAnchor),this.length=1):a&&!b?this.length||(this.views[0]=new d.Fragment(this.model.children,this.anglebars,this.parentNode,this.contextStack,this.sectionAnchor),this.length=1):this.length&&(this.unrender(),this.length=0)}}),Anglebars.views.Text=function(a,b,c){this.node=document.createTextNode(a.text),b.insertBefore(this.node,c||null)},Anglebars.views.Text.prototype={teardown:function(){Anglebars.utils.remove(this.node)}},Anglebars.views.Triple=Anglebars.view({initialize:function(){this.nodes=[],this.tripleAnchor=Anglebars.utils.createAnchor(),this.parentNode.insertBefore(this.tripleAnchor,this.anchor||null)},teardown:function(){while(this.nodes.length)Anglebars.utils.remove(this.nodes.shift());this.observerRefs?this.viewmodel.unobserveAll(this.observerRefs):this.viewmodel.cancelAddressResolution(this),Anglebars.utils.remove(this.anchor)},update:function(a){var b,c,d=Anglebars.utils;b=this.nodes.length;for(c=0;c<b;c+=1)d.remove(this.nodes[c]);this.nodes=d.getNodeArrayFromHtml(a,!1),b=this.nodes.length;for(c=0;c<b;c+=1)this.parentNode.insertBefore(this.nodes[c],this.tripleAnchor)}}),Anglebars.substring=function(a){var b;return b=function(a,b,c,d){var e=a.formatters;this.model=a,this.anglebars=b,this.viewmodel=b.viewmodel,this.parent=c,this.contextStack=d||[],this.initialize(),this.viewmodel.getKeypath(this,a.partialKeypath,d,function(c){var d,f=this;d=this.viewmodel.get(c),this.update(b._format(d,e)),this.observerRefs=this.viewmodel.observe(c,a.priority,function(a){f.update(b._format(a,e))})})},b.prototype=a,b},Anglebars.substrings.create=function(a,b,c,d){var e=Anglebars.substrings;switch(a.type){case"text":return new e.Text(a,c);case"interpolator":case"triple":return new e.Interpolator(a,b,c,d);case"section":return new e.Section(a,b,c,d)}},Anglebars.substrings.Fragment=function(a,b,c,d){var e,f;this.parent=c,this.items=[],e=a.length;for(f=0;f<e;f+=1)this.items[this.items.length]=Anglebars.substrings.create(a[f],b,this,d);this.value=this.items.join("")},Anglebars.substrings.Fragment.prototype={bubble:function(){this.value=this.items.join(""),this.parent.bubble()},teardown:function(){var a,b;a=this.items.length;for(b=0;b<a;b+=1)this.items[b].teardown()},toString:function(){return this.value||""}},Anglebars.substrings.Interpolator=Anglebars.substring({initialize:function(){},update:function(a){this.value=a,this.parent.bubble()},bubble:function(){this.parent.bubble()},teardown:function(){this.observerRefs?this.viewmodel.unobserveAll(this.observerRefs):this.viewmodel.cancelAddressResolution(this)},toString:function(){return this.value||""}}),Anglebars.substrings.Triple=Anglebars.substrings.Interpolator,Anglebars.substrings.Section=Anglebars.substring({initialize:function(){this.substrings=[],this.length=0},teardown:function(){this.unrender(),this.observerRefs?this.viewmodel.unobserveAll(this.observerRefs):this.viewmodel.cancelAddressResolution(this)},unrender:function(){while(this.substrings.length)this.substrings.shift().teardown();this.length=0},bubble:function(){this.value=this.substrings.join(""),this.parent.bubble()},update:function(a){var b,c,d=Anglebars.substrings,e;Anglebars.utils.isArray(a)&&a.length===0&&(b=!0);if(this.model.inverted){a&&!b?this.length&&(this.unrender(),this.length=0):this.length||(this.substrings[0]=new d.Fragment(this.model.children,this.anglebars,this,this.contextStack),this.length=1),this.value=this.substrings.join(""),this.parent.bubble();return}if(typeof a=="object")if(Anglebars.utils.isArray(a)){if(a.length<this.length){e=this.substrings.splice(a.length,this.length-a.length);while(e.length)e.shift().teardown()}else{for(c=0;c<this.length;c+=1)this.viewmodel.update(this.keypath+"."+c);if(a.length>this.length)for(c=this.length;c<a.length;c+=1)this.substrings[c]=new d.Fragment(this.model.children,this.anglebars,this,this.contextStack.concat(this.keypath+"."+c))}this.length=a.length}else this.length||(this.substrings[0]=new d.Fragment(this.model.children,this.anglebars,this,this.contextStack.concat(this.keypath)),this.length=1);else a&&!b?this.length||(this.substrings[0]=new d.Fragment(this.model.children,this.anglebars,this,this.contextStack),this.length=1):this.length&&(this.unrender(),this.length=0);this.value=this.substrings.join(""),this.parent.bubble()},toString:function(){return this.value||""}}),Anglebars.substrings.Text=function(a){this.text=a.text},Anglebars.substrings.Text.prototype={toString:function(){return this.text},teardown:function(){}},Anglebars.utils={remove:function(a){a.parentNode&&a.parentNode.removeChild(a)},trim:function(a){var b=a.replace(/^\s+/,"").replace(/\s+$/,"");return b},getNodeArrayFromHtml:function(a,b){var c,d,e,f=[],g,h,i;a=""+a;if(b){g=["src","poster"];for(d=0;d<g.length;d+=1)i=new RegExp("(<[^>]+\\s)("+g[d]+"=)","g"),a=a.replace(i,"$1data-anglebars-"+g[d]+"=")}var j=!0;if(j){h=["table","thead","tbody","tr","th","td"];for(d=0;d<h.length;d+=1)i=new RegExp("<("+h[d]+")(\\s|>)","gi"),a=a.replace(i,'<div data-anglebars-elementname="$1"$2'),i=new RegExp("<\\/"+h[d]+">","gi"),a=a.replace(i,"</div>")}c=document.createElement("div"),c.innerHTML=a,e=c.childNodes.length;for(d=0;d<e;d+=1)f[d]=c.childNodes[d];return f},getEl:function(a){var b;if(!a)throw new Error("No container element specified");if(a.tagName)return a;if(typeof a=="string"){b=document.getElementById(a);if(b.tagName)return b}throw new Error("Could not find container element")},splitKeypath:function(a){var b,c=[],d;b=a.split(".");for(d=0;d<b.length;d+=1)c=c.concat(Anglebars.utils.parseArrayNotation(b[d]));return c},parseArrayNotation:function(a){var b,c,d,e,f;b=a.indexOf("[");if(b===-1)return a;f=[a.substr(0,b)],c=a.substring(b),d=/\[([0-9]+)\]/;while(c.length){e=d.exec(c);if(!e)return f;f[f.length]=+e[1],c=c.substring(e[0].length)}return f},stripComments:function(a){var b,c,d,e,f;return b=this.escape(Anglebars.delimiters[0]),c=this.escape(Anglebars.delimiters[1]),d=new RegExp(b+"!\\s*[\\s\\S]+?\\s*"+c,"g"),e=new RegExp("(^|\\n|\\r\\n)\\s*"+b+"!\\s*[\\s\\S]+?\\s*"+c+"\\s*($|\\n|\\r\\n)","g"),f=a.replace(e,function(a,b){return b}),f=f.replace(d,""),f},createAnchor:function(){var a=document.createElement("a");return a.setAttribute("class","anglebars-anchor"),a.style.display="none",a},nodeListToArray:function(a){var b,c=a.length,d=[];for(b=0;b<c;b+=1)d[b]=a[b];return d},attributeListToArray:function(a){var b,c=a.length,d=[];for(b=0;b<c;b+=1)d[b]={name:a[b].name,value:a[b].value};return d},escape:function(a){var b=/[\[\]\(\)\{\}\^\$\*\+\?\.\|]/g;return a=a.replace(b,"\\$&"),a.replace(/\\/g,"\\")},compileMustachePattern:function(){Anglebars.patterns.mustache=new RegExp("(?:("+this.escape(Anglebars.tripleDelimiters[0])+")|("+this.escape(Anglebars.delimiters[0])+"))"+"(?:(?:"+"(=)\\s*([^\\s]+)\\s+([^\\s]+)\\s*(=)"+"(?:("+this.escape(Anglebars.tripleDelimiters[1])+")|("+this.escape(Anglebars.delimiters[1])+"))"+")|(?:"+"(#|\\^|\\/)?"+"(\\>)?"+"(&)?"+"\\s*"+"([\\s\\S]+?)"+"\\s*"+"(?:("+this.escape(Anglebars.tripleDelimiters[1])+")|("+this.escape(Anglebars.delimiters[1])+"))"+"))","g")},findMustache:function(a,b){var c,d,e,f,g,h,i,j,k;e=Anglebars.patterns.mustache,f=" | ",i=Anglebars.patterns.formatter,c=Anglebars.utils.findMatch(a,e,b);if(c){if(c[3]&&c[6])c.type="delimiterChange",c[1]&&c[7]?Anglebars.tripleDelimiters=[c[4],c[5]]:Anglebars.delimiters=[c[4],c[5]],Anglebars.utils.compileMustachePattern();else{c.formula=c[12],d=c.formula.split(f),c.partialKeypath=d.shift(),c.formatters=[];for(g=0;g<d.length;g+=1){h=i.exec(d[g]);if(h){j={name:h[1]};if(h[2])try{j.args=JSON.parse(h[2])}catch(l){throw new Error("Illegal arguments for formatter '"+j.name+"': "+h[2]+" (JSON.parse() failed)")}c.formatters.push(j)}}if(c[9])c.type="section",c.inverted=c[9]==="^"?!0:!1,c.closing=c[9]==="/"?!0:!1;else if(c[10])c.type="partial";else if(c[1]){if(!c[13])return!1;c.type="triple"}else c.type="interpolator"}return c.isMustache=!0,c}return!1},findMatch:function(a,b,c){var d;if(b.global)b.lastIndex=c||0;else throw new Error("You must pass findMatch() a regex with the global flag set");d=b.exec(a);if(d)return d.end=b.lastIndex,d.start=d.end-d[0].length,d},getStubsFromNodes:function(a){var b,c,d,e=[],f;c=a.length;for(b=0;b<c;b+=1)d=a[b],d.nodeType===1?e[e.length]={type:"element",original:d}:d.nodeType===3&&(f=Anglebars.utils.expandText(d.data),f&&(e=e.concat(f)));return e},expandText:function(a){var b=[],c,d,e,f,g,h,i;c=Anglebars.utils.findMustache(a);while(c.type==="delimiterChange")c.start>0&&(b[b.length]={type:"text",text:a.substr(0,c.start)}),a=a.substring(c.end),c=Anglebars.utils.findMustache(a);return c?(h=!0,e=/\s*\n\s*$/,c.start>0&&(f=a.substr(0,c.start),b[b.length]={type:"text",text:f}),b[b.length]={type:"mustache",mustache:c},c.end<a.length&&(i=Anglebars.utils.expandText(a.substring(c.end)),i&&(b=b.concat(i))),b):a?b.concat({type:"text",text:a}):b.length?b:!1},setText:function(a,b){a.textContent!==undefined?a.textContent=b:a.data=b},isEqual:function(a,b){var c=function(a,b,d){var e,f,g,h,i,j;e=Object.prototype.toString;if(a===b)return a!==0||1/a==1/b;if(a==null||b==null)return a===b;f=e.call(a);if(f!=e.call(b))return!1;switch(f){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if(typeof a!="object"||typeof b!="object")return!1;g=d.length;while(g--)if(d[g]==a)return!0;d.push(a),h=0,i=!0;if(f=="[object Array]"){h=a.length,i=h==b.length;if(i)while(h--)if(!(i=h in a==h in b&&c(a[h],b[h],d)))break}else{if("constructor"in a!="constructor"in b||a.constructor!=b.constructor)return!1;for(j in a)if(a.hasOwnProperty(j)){h++;if(!(i=b.hasOwnProperty(j)&&c(a[j],b[j],d)))break}if(i){for(j in b)if(b.hasOwnProperty(j)&&!(h--))break;i=!h}}return d.pop(),i};return c(a,b,[])},isArray:function(a){return Object.prototype.toString.call(a)==="[object Array]"},isObject:function(a){return Object.prototype.toString.call(a)==="[object Object]"&&typeof a!="function"},compileStubs:function(a,b,c,d){var e,f,g;e=[],g=function(f){var g,h,i,j,k,l,m,n,o,p,q;g=/^\s*\n\r?\s*$/,l=a[f];switch(l.type){case"text":if(!d)if(g.test(l.text)||l.text==="")return f+1;return e[e.length]=l,f+1;case"element":return e[e.length]=Anglebars.utils.processElementStub(l,b,c),f+1;case"mustache":q=l.mustache.partialKeypath;switch(l.mustache.type){case"section":f+=1,m=f,o=1;while(f<a.length&&!n)p=a[f],p.type==="mustache"&&p.mustache.type==="section"&&p.mustache.partialKeypath===q&&(p.mustache.closing?(o-=1,o||(n=f)):o+=1),f+=1;if(!n)throw new Error('Illegal section "'+q+'"');return e[e.length]={type:"section",partialKeypath:q,formatters:l.mustache.formatters,inverted:l.mustache.inverted,children:Anglebars.utils.compileStubs(a.slice(m,n),b+1,c,d),priority:b},f;case"triple":return e[e.length]={type:"triple",partialKeypath:l.mustache.partialKeypath,formatters:l.mustache.formatters,priority:b},f+1;case"interpolator":return e[e.length]={type:"interpolator",partialKeypath:l.mustache.partialKeypath,formatters:l.mustache.formatters,priority:b},f+1;default:throw new Error("Error compiling template")}break;default:throw new Error("Error compiling template")}},f=0;while(f<a.length)f=g(f);return e},processElementStub:function(a,b,c){var d,e,f,g,h,i,j=Anglebars.utils;i=a.original,d={type:"element",tag:i.getAttribute("data-anglebars-elementname")||i.localName,priority:b},c&&(d.namespace=c),e=[],f=i.attributes.length;for(h=0;h<f;h+=1){g=i.attributes[h];if(e.name==="data-anglebars-elementname")continue;g.name==="xmlns"?d.namespace=g.value:e[e.length]=j.processAttribute(g.name,g.value,b+1)}return d.attributes=e,d.children=j.compileStubs(j.getStubsFromNodes(i.childNodes),b+1,d.namespace),d},processAttribute:function(a,b,c){var d,e,f=Anglebars.utils;return e=f.expandText(b),d={name:a.replace("data-anglebars-","")},!f.findMustache(b)||!e?(d.value=b,d):(d.isDynamic=!0,d.priority=c,d.components=f.compileStubs(e,c,null),d)}};